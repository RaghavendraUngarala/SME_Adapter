
@using SMEAdapter.Application.DTOs
@using BlazorApp.Components.Product   
@using System.IO
@inject NavigationManager Navigation
@inject SMEAdapter.Application.Services.CompanyInfoService CompanyInfo
@inject ISnackbar Snackbar
@using BlazorApp.Components.LangStringSetEditor


<MudStack Row="true" AlignItems="AlignItems.Baseline">
    <MudText Typo="Typo.h3" >Company Details</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.HelpOutline"
                   Color="Color.Primary"
                   Size="Size.Small"
                   Target="_blank"
                   Href="https://github.com/Ra-one77/SME_Adapter/wiki/Company-Details"
                   Style="margin-top: 10px;"
                   title="Help: Company Name" />
</MudStack>

<MudGrid>
    <MudItem xs="12" sm="12" md="6">
      

            <EditForm Model="@company" OnValidSubmit="HandleValidSubmit">

                <DataAnnotationsValidator />

                <MudText Typo="Typo.h5" Class="font-semibold">Manufacturer Name</MudText>

                <LangStringSetEditor Value="company.CompanyManufacturerName"
                                     ValueChanged="OnCompanyNameChanged"
                                     Label="Company Name"
                                     InputLabel="Name"
                                     MinRows="1"
                                     HelpText="Full legal name of the company" />

                <MudDivider Class="my-2" />

                <MudText Typo="Typo.h5" Class="font-semibold">Address Information</MudText>
                <MudDivider Class="my-2" />

                <MudText Typo="Typo.h6" Class="font-semibold mt-2">Zip Code</MudText>
                <LangStringSetEditor Value="company.CompanyAddressInfo.ZipCode"
                                     ValueChanged="OnZipCodeChanged"
                                     Label="Zip Code"
                                     InputLabel="ZIP"
                                     MinRows="1"
                                     HelpText="ZIP or postal code" />

                <MudText Typo="Typo.h6" Class="font-semibold mt-2">City</MudText>
                <LangStringSetEditor Value="company.CompanyAddressInfo.City"
                                     ValueChanged="OnCityChanged"
                                     Label="City"
                                     InputLabel="City"
                                     MinRows="1"
                                     HelpText="City where the company is based" />

                <MudText Typo="Typo.h6" Class="font-semibold mt-2">Country</MudText>
                <LangStringSetEditor Value="company.CompanyAddressInfo.Country"
                                     ValueChanged="OnCountryChanged"
                                     Label="Country"
                                     InputLabel="Country"
                                     MinRows="1"
                                     HelpText="Country where the company is based" />

                <MudText Typo="Typo.h6" Class="mt-4">Upload Company Logo</MudText>
                <InputFile OnChange="OnFilesChanged" accept=".png,.jpg,.jpeg,.pdf" />

                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton Variant="Variant.Outlined" ButtonType="ButtonType.Submit" Color = "Color.Secondary" Size="Size.Large"
                               Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                        Save
                    </MudButton>

                   
                </MudStack>

            </EditForm>
        
        
    </MudItem>
</MudGrid>

@code {
    // ---------------------------
    // PARAMETERS
    // ---------------------------
    [Parameter]
    public CompanyDto? ExistingCompany { get; set; }

    [Parameter]
    public EventCallback<CompanyDto> OnCompleted { get; set; }

    private bool IsEditMode => ExistingCompany != null;

    // ---------------------------
    // INTERNAL MODEL
    // ---------------------------
    private CompanyDto company = new();
    private IBrowserFile? uploadedFile;

    protected override void OnInitialized()
    {
        if (IsEditMode)
        {
            // Deep copy existing values
            company = new CompanyDto
            {
                Id = ExistingCompany!.Id,
                CompanyImageUrl = ExistingCompany.CompanyImageUrl,
                CompanyManufacturerName = new Dictionary<string, string>(ExistingCompany.CompanyManufacturerName, StringComparer.OrdinalIgnoreCase),
                CompanyAddressInfo = new CompanyAddressInfoDto
                {
                    ZipCode = new Dictionary<string, string>(ExistingCompany.CompanyAddressInfo.ZipCode, StringComparer.OrdinalIgnoreCase),
                    City = new Dictionary<string, string>(ExistingCompany.CompanyAddressInfo.City, StringComparer.OrdinalIgnoreCase),
                    Country = new Dictionary<string, string>(ExistingCompany.CompanyAddressInfo.Country, StringComparer.OrdinalIgnoreCase)
                }
            };
        }
        else
        {
            // NEW COMPANY: initialize dictionaries
            company.CompanyManufacturerName ??= new(StringComparer.OrdinalIgnoreCase);

            company.CompanyAddressInfo ??= new();
            company.CompanyAddressInfo.ZipCode ??= new(StringComparer.OrdinalIgnoreCase);
            company.CompanyAddressInfo.City ??= new(StringComparer.OrdinalIgnoreCase);
            company.CompanyAddressInfo.Country ??= new(StringComparer.OrdinalIgnoreCase);
        }
    }

    // ---------------------------
    // FIELD CHANGES
    // ---------------------------
    private void OnCompanyNameChanged(Dictionary<string, string>? v)
        => company.CompanyManufacturerName = v ?? new(StringComparer.OrdinalIgnoreCase);

    private void OnZipCodeChanged(Dictionary<string, string>? v)
        => company.CompanyAddressInfo.ZipCode = v ?? new(StringComparer.OrdinalIgnoreCase);

    private void OnCityChanged(Dictionary<string, string>? v)
        => company.CompanyAddressInfo.City = v ?? new(StringComparer.OrdinalIgnoreCase);

    private void OnCountryChanged(Dictionary<string, string>? v)
        => company.CompanyAddressInfo.Country = v ?? new(StringComparer.OrdinalIgnoreCase);

    // ---------------------------
    // SUBMIT
    // ---------------------------
    private async Task HandleValidSubmit()
    {
        SaveSnackBar();
        await OnCompleted.InvokeAsync(company);
    }

    private void SaveSnackBar()
    {
        Snackbar.Add(IsEditMode ? "Company updated successfully!" :
                                 "Company created successfully!",
                     Severity.Success, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });
    }

    // ---------------------------
    // FILE UPLOAD
    // ---------------------------
    private async Task OnFilesChanged(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;

        var path = Path.Combine("wwwroot/images", uploadedFile.Name);

        using var fs = new FileStream(path, FileMode.Create);
        await uploadedFile.OpenReadStream().CopyToAsync(fs);

        company.CompanyImageUrl = $"images/{uploadedFile.Name}";
    }
}

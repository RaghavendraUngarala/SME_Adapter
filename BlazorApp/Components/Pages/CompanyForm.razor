@using SMEAdapter.Application.DTOs
@using BlazorApp.Components.Product
@using System.IO
@inject NavigationManager Navigation
@inject SMEAdapter.Application.Services.CompanyInfoService CompanyInfo
@inject ISnackbar Snackbar
@using BlazorApp.Components.LangStringSetEditor

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

    .company-form-page {
        font-family: 'Poppins', 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .page-title {
        font-weight: 800;
        font-size: 2.75rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
    }

    .section-title {
        font-weight: 800;
        font-size: 1.75rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
        margin-bottom: 1.5rem;
    }

    .field-label {
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
        margin-bottom: 0.5rem;
        margin-top: 1rem;
    }

    .body-text {
        font-weight: 500;
        font-size: 1.05rem;
    }

    .btn-text {
        font-weight: 600;
        font-size: 1.05rem;
        letter-spacing: 0.01em;
    }

    .form-paper {
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .form-paper:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

    .image-preview {
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        padding: 8px;
        transition: all 0.2s ease;
    }

        .image-preview:hover {
            border-color: var(--mud-palette-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
</style>

<MudContainer MaxWidth="MaxWidth.False" Class="company-form-page py-6 px-6" Style="max-width: 100%;">

    <!-- Page Header -->
    <MudPaper Class="pa-6 mb-4" Elevation="3">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Spacing="2">
                <MudText Class="page-title">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-3" Size="Size.Large" />
                    @(IsEditMode ? "Edit Company Details" : "Add Company Details")
                </MudText>
                <MudText Class="body-text" Color="Color.Secondary">
                    Fill in your company information below
                </MudText>
            </MudStack>
            <MudIconButton Icon="@Icons.Material.Filled.HelpOutline"
                           Color="Color.Primary"
                           Size="Size.Large"
                           Target="_blank"
                           Href="https://github.com/Ra-one77/SME_Adapter/wiki/Company-Details"
                           title="Help: Company Details" />
        </MudStack>
    </MudPaper>

    <EditForm Model="@company" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />

        <MudGrid>
            <!-- Company Information -->
            <MudItem xs="12" md="8">
                <MudPaper Class="form-paper pa-6 mb-4" Elevation="3">
                    <MudText Class="section-title" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
                        Company Information
                    </MudText>

                    <MudText Class="field-label">Manufacturer Name</MudText>
                    <LangStringSetEditor Value="company.CompanyManufacturerName"
                                         ValueChanged="OnCompanyNameChanged"
                                         Label="Company Name"
                                         InputLabel="Name"
                                         MinRows="1"
                                         HelpText="Full legal name of the company"
                                         LanguageWidth="200px"
                                         TextWidth="100%" />
                </MudPaper>

                <!-- Address Information -->
                <MudPaper Class="form-paper pa-6" Elevation="3">
                    <MudText Class="section-title" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Class="mr-2" />
                        Address Information
                    </MudText>

                    <MudText Class="field-label">Zip Code</MudText>
                    <LangStringSetEditor Value="company.CompanyAddressInfo.ZipCode"
                                         ValueChanged="OnZipCodeChanged"
                                         Label="Zip Code"
                                         InputLabel="ZIP"
                                         MinRows="1"
                                         HelpText="ZIP or postal code"
                                         LanguageWidth="200px"
                                         TextWidth="100%" />

                    <MudText Class="field-label">City</MudText>
                    <LangStringSetEditor Value="company.CompanyAddressInfo.City"
                                         ValueChanged="OnCityChanged"
                                         Label="City"
                                         InputLabel="City"
                                         MinRows="1"
                                         HelpText="City where the company is based"
                                         LanguageWidth="200px"
                                         TextWidth="100%" />

                    <MudText Class="field-label">Country</MudText>
                    <LangStringSetEditor Value="company.CompanyAddressInfo.Country"
                                         ValueChanged="OnCountryChanged"
                                         Label="Country"
                                         InputLabel="Country"
                                         MinRows="1"
                                         HelpText="Country where the company is based"
                                         LanguageWidth="200px"
                                         TextWidth="100%" />
                </MudPaper>
            </MudItem>

            <!-- Company Logo Section -->
            <MudItem xs="12" md="4">
                <MudPaper Class="form-paper pa-6" Elevation="3">
                    <MudText Class="section-title" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.Image" Class="mr-2" />
                        Company Logo
                    </MudText>

                    <MudFileUpload T="IBrowserFile"
                                   MaximumFileCount="1"
                                   Accept="image/*"
                                   FilesChanged="OnFilesChanged">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.CloudUpload"
                                       Size="Size.Large"
                                       FullWidth="true"
                                       Class="btn-text mb-4">
                                Upload Logo
                            </MudButton>
                        </ActivatorContent>

                        <SelectedTemplate Context="selectedFileContext">
                            @if (selectedFileContext != null)
                            {
                                <MudChip T="string" Color="Color.Success"
                                         Icon="@Icons.Material.Filled.CheckCircle"
                                         Size="Size.Medium"
                                         Style="font-weight: 600;">
                                    @selectedFileContext.Name
                                </MudChip>
                            }
                            else if (!string.IsNullOrWhiteSpace(company?.CompanyImageUrl))
                            {
                                <MudChip T="string" Color="Color.Info"
                                         Icon="@Icons.Material.Filled.Image"
                                         Size="Size.Medium"
                                         Style="font-weight: 600;">
                                    Current: @Path.GetFileName(company.CompanyImageUrl)
                                </MudChip>
                            }
                            else
                            {
                                <MudText Class="body-text" Color="Color.Secondary">No logo selected</MudText>
                            }
                        </SelectedTemplate>
                    </MudFileUpload>

                    @if (!string.IsNullOrWhiteSpace(company?.CompanyImageUrl))
                    {
                        <MudPaper Class="image-preview pa-2 mt-4" Elevation="0">
                            <MudImage Src="@company.CompanyImageUrl"
                                      Alt="Company Logo"
                                      ObjectFit="ObjectFit.Contain"
                                      Style="width: 100%; height: 200px; border-radius: 8px;" />
                        </MudPaper>
                    }
                    else
                    {
                        <MudPaper Class="pa-8 mt-4 text-center" Elevation="0" Style="background: #f5f5f5; border-radius: 12px;">
                            <MudIcon Icon="@Icons.Material.Outlined.Image"
                                     Size="Size.Large"
                                     Color="Color.Secondary"
                                     Style="font-size: 4rem; opacity: 0.3;" />
                            <MudText Class="body-text mt-2" Color="Color.Secondary">
                                No logo uploaded yet
                            </MudText>
                        </MudPaper>
                    }
                </MudPaper>
            </MudItem>

            <!-- Action Buttons -->
            <MudItem xs="12">
                <MudPaper Class="pa-6" Elevation="3">
                    <MudStack Row="true" Spacing="3">
                        <MudButton Variant="Variant.Filled"
                                   ButtonType="ButtonType.Submit"
                                   Color="Color.Success"
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Save"
                                   Class="btn-text">
                            @(IsEditMode ? "Update Company" : "Save Company")
                        </MudButton>

                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Default"
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Cancel"
                                   OnClick="@(() => Navigation.NavigateTo("/"))"
                                   Class="btn-text">
                            Cancel
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </EditForm>
</MudContainer>

@code {
    [Parameter]
    public CompanyDto? ExistingCompany { get; set; }

    [Parameter]
    public EventCallback<CompanyDto> OnCompleted { get; set; }

    private bool IsEditMode => ExistingCompany != null;
    private CompanyDto company = new();
    private IBrowserFile? uploadedFile;
    private string companyImageUrl = string.Empty;

    protected override void OnInitialized()
    {
        if (IsEditMode)
        {
            company = new CompanyDto
            {
                Id = ExistingCompany!.Id,
                CompanyImageUrl = ExistingCompany.CompanyImageUrl,
                CompanyManufacturerName = new Dictionary<string, string>(ExistingCompany.CompanyManufacturerName, StringComparer.OrdinalIgnoreCase),
                CompanyAddressInfo = new CompanyAddressInfoDto
                {
                    ZipCode = new Dictionary<string, string>(ExistingCompany.CompanyAddressInfo.ZipCode, StringComparer.OrdinalIgnoreCase),
                    City = new Dictionary<string, string>(ExistingCompany.CompanyAddressInfo.City, StringComparer.OrdinalIgnoreCase),
                    Country = new Dictionary<string, string>(ExistingCompany.CompanyAddressInfo.Country, StringComparer.OrdinalIgnoreCase)
                }
            };
            companyImageUrl = company.CompanyImageUrl ?? string.Empty;
        }
        else
        {
            company.CompanyManufacturerName ??= new(StringComparer.OrdinalIgnoreCase);
            company.CompanyAddressInfo ??= new();
            company.CompanyAddressInfo.ZipCode ??= new(StringComparer.OrdinalIgnoreCase);
            company.CompanyAddressInfo.City ??= new(StringComparer.OrdinalIgnoreCase);
            company.CompanyAddressInfo.Country ??= new(StringComparer.OrdinalIgnoreCase);
        }
    }

    private void OnCompanyNameChanged(Dictionary<string, string>? v)
        => company.CompanyManufacturerName = v ?? new(StringComparer.OrdinalIgnoreCase);

    private void OnZipCodeChanged(Dictionary<string, string>? v)
        => company.CompanyAddressInfo.ZipCode = v ?? new(StringComparer.OrdinalIgnoreCase);

    private void OnCityChanged(Dictionary<string, string>? v)
        => company.CompanyAddressInfo.City = v ?? new(StringComparer.OrdinalIgnoreCase);

    private void OnCountryChanged(Dictionary<string, string>? v)
        => company.CompanyAddressInfo.Country = v ?? new(StringComparer.OrdinalIgnoreCase);

    private async Task HandleValidSubmit()
    {
        // If editing and no new file was uploaded, keep the existing URL
        if (IsEditMode && uploadedFile == null)
        {
            company.CompanyImageUrl = companyImageUrl;
            
        }

        SaveSnackBar();
        
        await OnCompleted.InvokeAsync(company);
    }

    private void SaveSnackBar()
    {
        Snackbar.Add(IsEditMode ? "Company updated successfully!" : "Company created successfully!",
                     Severity.Success, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });
    }

    private async Task OnFilesChanged(IBrowserFile file)
    {
        uploadedFile = file;
        if (uploadedFile == null)
            return;

        await SaveImageFile(uploadedFile);
        StateHasChanged();
    }

    private async Task SaveImageFile(IBrowserFile file)
    {
        try
        {
            var maxSize = 10 * 1024 * 1024; // 10 MB
            var fileName = file.Name;

            // Ensure directory exists
            var imagesPath = Path.Combine("wwwroot", "images");
            if (!Directory.Exists(imagesPath))
            {
                Directory.CreateDirectory(imagesPath);
            }

            var uploadPath = Path.Combine(imagesPath, fileName);

            await using var fs = new FileStream(uploadPath, FileMode.Create);
            await file.OpenReadStream(maxSize).CopyToAsync(fs);

            company.CompanyImageUrl = $"/images/{fileName}";
            companyImageUrl = company.CompanyImageUrl;

            Snackbar.Add("Logo uploaded successfully!", Severity.Success, config =>
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            });
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error uploading file: {ex.Message}", Severity.Error, config =>
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
            });
        }
    }
}

@using SMEAdapter.Application.DTOs
@using System.IO
@inject NavigationManager Navigation
@inject SMEAdapter.Application.Services.CompanyInfoService CompanyInfo
@inject ISnackbar Snackbar


<br/>
<MudStack Row="true" AlignItems="AlignItems.Baseline">
    <MudText Typo="Typo.h3" Class="pl-4">Company Details</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.HelpOutline"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       Target="_blank"
                                       Href="https://github.com/Ra-one77/SME_Adapter/wiki/Company-Details"
                                       Style="margin-top: 10px;"
                                       title="Help: Company Name" />
</MudStack>
<MudGrid>
    <MudItem xs="12" sm="12" md="6">
        <MudPaper Class="pa-6 ma-4" Elevation="8" Style="border: 1px solid lightgray; border-radius: 8px;">
        <EditForm Model="@company" OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
        <DataAnnotationsValidator/>

             <MudText Typo="Typo.h5" Class="font-semibold">Manufacturer Name</MudText>
                
                 <MudTextField Class="custom-font" T="string" HelperTextOnFocus="true" HelperText="Full legal name of the product manufacturer" Variant="Variant.Outlined"  Placeholder ="MusterGmbh" @bind-Value="company.CompanyManufacturerName" For="@(() => company.CompanyManufacturerName)" />
                    
            <MudDivider Class="my-2" />

                <MudText Typo="Typo.h5" Class="font-semibold">Address Info</MudText>

            <MudDivider Class="my-2" />

                <MudText Typo="Typo.h6" Class="font-semibold">Zip Code</MudText>
                <MudTextField Class="custom-font" T="string" HelperTextOnFocus="true" HelperText="ZIP or postal code for the manufacturer’s address"   Variant="Variant.Outlined" Placeholder="1234" @bind-Value="company.CompanyAddressInfo.ZipCode" For="@(() => company.CompanyAddressInfo.ZipCode)" />
              

                <MudText Typo="Typo.h6" Class="font-semibold">City</MudText>
                <MudTextField Class="custom-font" T="string" HelperTextOnFocus="true" HelperText="Group of related products that share similar features" Variant="Variant.Outlined" Placeholder="Musterstadt" @bind-Value="company.CompanyAddressInfo.City" For="@(() => company.CompanyAddressInfo.City)" />
                

                <MudText Typo="Typo.h6" Class="font-semibold">Country</MudText>
                <MudTextField Class="custom-font" T="string" HelperTextOnFocus="true" HelperText="Country where the manufacturer is based" Variant="Variant.Outlined" Placeholder="Muster-Bundesland" @bind-Value="company.CompanyAddressInfo.Country" For="@(() => company.CompanyAddressInfo.Country)" />

            <MudText Typo="Typo.h6" Class="mt-4">Upload Company Logo</MudText>
            <InputFile OnChange="OnFilesChanged" accept=".png,.jpg,.jpeg,.pdf" />

            <MudStack Row="true" Spacing="2" Class="mt-4">
                <MudButton Variant="Variant.Outlined"  ButtonType="ButtonType.Submit" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                    Save
                </MudButton>
                <MudButton Href="/" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                    Home Page
                </MudButton>
            </MudStack>
        </EditForm>
        </MudPaper>
    </MudItem>
</MudGrid>


@code {

    private CompanyDto company = new CompanyDto();

    private IBrowserFile? uploadedFile;

    [Parameter] 
    public EventCallback<CompanyDto> OnCompleted { get; set; }

    private async Task HandleValidSubmit()
    {
        CompanyInfo.SetCompany(company);
        SaveSnackBar();

        await InvokeAsync(() => OnCompleted.InvokeAsync(company));
    }

    private void HandleInvalidSubmit()
    {
        Console.WriteLine("Invalid submit");
    }

    private async Task OnFilesChanged(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        var path = Path.Combine("wwwroot/images", uploadedFile.Name);

        using var fs = new FileStream(path, FileMode.Create);
        await uploadedFile.OpenReadStream().CopyToAsync(fs);

        company.CompanyImageUrl = $"images/{uploadedFile.Name}";
    }

    private void SaveSnackBar()
    {
        Snackbar.Add("The company details have been saved successfully", Severity.Success, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });

    }

}

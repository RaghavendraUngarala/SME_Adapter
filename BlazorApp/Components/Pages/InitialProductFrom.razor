@using MediatR;
@using SMEAdapter.Application.DTOs;
@inject SMEAdapter.Application.Services.CompanyInfoService CompanyInfo
@inject NavigationManager navigate
@using SMEAdapter.Application.Products.CreateProduct
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using BlazorApp.Components.Pages;
@using SMEAdapter.Application.Products.Queries.GetProducts
@using SMEAdapter.Application.Products.Queries.GetProductById
@using SMEAdapter.Application.Products.UpdateProduct
@using BlazorApp.Components.LangStringSetEditor

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

    .product-form-page {
        font-family: 'Poppins', 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .page-title {
        font-weight: 800;
        font-size: 2.75rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
    }

    .section-title {
        font-weight: 800;
        font-size: 1.75rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
        margin-bottom: 1.5rem;
    }

    .field-label {
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
        margin-bottom: 0.5rem;
        margin-top: 1rem;
    }

    .body-text {
        font-weight: 500;
        font-size: 1.05rem;
    }

    .btn-text {
        font-weight: 600;
        font-size: 1.05rem;
        letter-spacing: 0.01em;
    }

    .form-paper {
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .form-paper:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

    .image-preview {
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        padding: 8px;
        transition: all 0.2s ease;
    }

        .image-preview:hover {
            border-color: var(--mud-palette-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
</style>

@if (IsFirstProduct)
{
    <MudContainer MaxWidth="MaxWidth.False" Class="product-form-page py-6 px-6" Style="max-width: 100%;">

        <!-- Page Header -->
        <MudPaper Class="pa-6 mb-4" Elevation="3">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Spacing="2">
                    <MudText Class="page-title">
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-3" Size="Size.Large" />
                        @(IsEditMode ? "Edit Product" : "Add New Product")
                    </MudText>
                    <MudText Class="body-text" Color="Color.Secondary">
                        Fill in the product details below
                    </MudText>
                </MudStack>
                <MudIconButton Icon="@Icons.Material.Filled.HelpOutline"
                               Color="Color.Primary"
                               Size="Size.Large"
                               Target="_blank"
                               Href="https://github.com/Ra-one77/SME_Adapter/wiki/Product-Info"
                               title="Help: Product Info" />
            </MudStack>
        </MudPaper>

        <EditForm Model="@product" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <MudGrid>
                <!-- Main Product Information -->
                <MudItem xs="12" md="8">
                    <MudPaper Class="form-paper pa-6" Elevation="3">
                        <MudText Class="section-title" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                            Product Information
                        </MudText>

                        <MudText Class="field-label">Product Family</MudText>
                        <LangStringSetEditor Value="product.ProductInfo.ProductFamily"
                                             ValueChanged="OnProductFamilyChanged"
                                             Label="Product Family"
                                             InputLabel="Family"
                                             MinRows="1"
                                             HelpText="Group of related products that share similar features"
                                             LanguageWidth="180px"
                                             TextWidth="100%" />

                        <MudText Class="field-label">Product Root</MudText>
                        <LangStringSetEditor Value="product.ProductInfo.ProductRoot"
                                             ValueChanged="OnProductRootChanged"
                                             Label="Product Root"
                                             InputLabel="Root"
                                             MinRows="1"
                                             HelpText="Base model from which product variants are derived"
                                             LanguageWidth="180px"
                                             TextWidth="100%" />

                        <MudText Class="field-label">Product Type</MudText>
                        <LangStringSetEditor Value="product.ProductInfo.ProductType"
                                             ValueChanged="OnProductTypeChanged"
                                             Label="Product Type"
                                             InputLabel="Type"
                                             MinRows="1"
                                             HelpText="General category the product belongs to"
                                             LanguageWidth="180px"
                                             TextWidth="100%" />

                        <MudText Class="field-label">Product Designation</MudText>
                        <LangStringSetEditor Value="product.ProductInfo.ProductDesignation"
                                             ValueChanged="OnProductDesignationChanged"
                                             Label="Product Designation"
                                             InputLabel="Designation"
                                             MinRows="1"
                                             HelpText="Official name used to market or identify this product"
                                             LanguageWidth="180px"
                                             TextWidth="100%" />

                        <MudText Class="field-label">Serial Number</MudText>
                        <LangStringSetEditor Value="product.SerialNumber"
                                             ValueChanged="OnSerialNumberChanged"
                                             Label="Serial Number"
                                             InputLabel="Serial"
                                             MinRows="1"
                                             HelpText="Internal code used for stock and inventory tracking"
                                             LanguageWidth="180px"
                                             TextWidth="100%" />

                        <MudText Class="field-label">Order Code</MudText>
                        <LangStringSetEditor Value="product.ProductInfo.OrderCode"
                                             ValueChanged="OnOrderCodeChanged"
                                             Label="Order Code"
                                             InputLabel="Order Code"
                                             MinRows="1"
                                             HelpText="Code customers use to order this exact configuration"
                                             LanguageWidth="180px"
                                             TextWidth="100%" />

                        <MudText Class="field-label">Article Number</MudText>
                        <LangStringSetEditor Value="product.ProductInfo.ArticleNumber"
                                             ValueChanged="OnArticleNumberChanged"
                                             Label="Article Number"
                                             InputLabel="Article Number"
                                             MinRows="1"
                                             HelpText="Unique identifier for each individual unit. Used for warranty and traceability"
                                             LanguageWidth="180px"
                                             TextWidth="100%" />
                    </MudPaper>
                </MudItem>

                <!-- Product Image Section -->
                <MudItem xs="12" md="4">
                    <MudPaper Class="form-paper pa-6" Elevation="3">
                        <MudText Class="section-title" Color="Color.Primary">
                            <MudIcon Icon="@Icons.Material.Filled.Image" Class="mr-2" />
                            Product Image
                        </MudText>

                        <MudFileUpload T="IBrowserFile"
                                       MaximumFileCount="1"
                                       Accept="image/*"
                                       FilesChanged="OnFilesChanged">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           Size="Size.Large"
                                           FullWidth="true"
                                           Class="btn-text mb-4">
                                     Upload Image
                                </MudButton>
                            </ActivatorContent>

                            <SelectedTemplate Context="selectedFileContext">
                                @if (selectedFileContext != null)
                                {
                                    <MudChip T="string" Color="Color.Success"
                                             Icon="@Icons.Material.Filled.CheckCircle"
                                             Size="Size.Medium"
                                             Style="font-weight: 600;">
                                        @selectedFileContext.Name
                                    </MudChip>
                                }
                                else if (!string.IsNullOrWhiteSpace(product?.ImageUrl))
                                {
                                    <MudChip T="string" Color="Color.Info"
                                             Icon="@Icons.Material.Filled.Image"
                                             Size="Size.Medium"
                                             Style="font-weight: 600;">
                                        Current: @Path.GetFileName(product.ImageUrl)
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Class="body-text" Color="Color.Secondary">No image selected</MudText>
                                }
                            </SelectedTemplate>
                        </MudFileUpload>

                        @if (!string.IsNullOrWhiteSpace(product?.ImageUrl))
                        {
                            <MudPaper Class="image-preview pa-2 mt-4" Elevation="0">
                                <MudImage Src="@product.ImageUrl"
                                          Alt="Product Image"
                                          ObjectFit="ObjectFit.Cover"
                                          Style="width: 100%; height: 300px; border-radius: 8px;" />
                            </MudPaper>
                        }
                        else
                        {
                            <MudPaper Class="pa-8 mt-4 text-center" Elevation="0" Style="background: #f5f5f5; border-radius: 12px;">
                                <MudIcon Icon="@Icons.Material.Outlined.Image"
                                         Size="Size.Large"
                                         Color="Color.Secondary"
                                         Style="font-size: 4rem; opacity: 0.3;" />
                                <MudText Class="body-text mt-2" Color="Color.Secondary">
                                    No image uploaded yet
                                </MudText>
                            </MudPaper>
                        }
                    </MudPaper>
                </MudItem>

                <!-- Action Buttons -->
                <MudItem xs="12">
                    <MudPaper Class="pa-6" Elevation="3">
                        <MudStack Row="true" Spacing="3">
                            <MudButton Variant="Variant.Filled"
                                       ButtonType="ButtonType.Submit"
                                       Color="Color.Success"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Save"
                                       Class="btn-text">
                                @(IsEditMode ? "Update Product" : "Save Product")
                            </MudButton>

                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       Size="Size.Large"
                                       StartIcon="@Icons.Material.Filled.Cancel"
                                       OnClick="@(() => navigate.NavigateTo("/viewproducts"))"
                                       Class="btn-text">
                                Cancel
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.False" Class="product-form-page py-6 px-6">
        <MudPaper Class="pa-12 text-center" Elevation="3">
            <MudIcon Icon="@Icons.Material.Outlined.Business"
                     Color="Color.Secondary"
                     Style="font-size: 5rem; opacity: 0.3;" />
            <MudText Class="section-title mt-4 mb-2">No Company Details Found</MudText>
            <MudText Class="body-text mb-6" Color="Color.Secondary">
                Please enter company details before adding products
            </MudText>
            <MudButton Href="/companyform"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.Add"
                       Class="btn-text">
                Add Company Details
            </MudButton>
        </MudPaper>
    </MudContainer>
}

@code {
    [Parameter]
    public bool IsFirstProduct { get; set; }

    [Parameter]
    public bool IsEditMode { get; set; } = false;

    [Parameter]
    public Guid ProductId { get; set; }

    [Parameter]
    public Guid CompanyId { get; set; }

    private ProductDto? product;
    private string productImageUrl = string.Empty;
    private IBrowserFile? selectedFile;

    // ---------- LangStringSetEditor handlers ----------
    private void OnManufacturerNameChanged(Dictionary<string, string>? v)
    {
        if (product == null) return;
        product.ManufacturerName = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnZipCodeChanged(Dictionary<string, string>? v)
    {
        if (product?.AddressInfo == null) return;
        product.AddressInfo.ZipCode = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnCityChanged(Dictionary<string, string>? v)
    {
        if (product?.AddressInfo == null) return;
        product.AddressInfo.City = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnCountryChanged(Dictionary<string, string>? v)
    {
        if (product?.AddressInfo == null) return;
        product.AddressInfo.Country = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnProductFamilyChanged(Dictionary<string, string>? v)
    {
        if (product?.ProductInfo == null) return;
        product.ProductInfo.ProductFamily = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnProductRootChanged(Dictionary<string, string>? v)
    {
        if (product?.ProductInfo == null) return;
        product.ProductInfo.ProductRoot = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnProductTypeChanged(Dictionary<string, string>? v)
    {
        if (product?.ProductInfo == null) return;
        product.ProductInfo.ProductType = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnProductDesignationChanged(Dictionary<string, string>? v)
    {
        if (product?.ProductInfo == null) return;
        product.ProductInfo.ProductDesignation = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnSerialNumberChanged(Dictionary<string, string>? v)
    {
        if (product == null) return;
        product.SerialNumber = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnOrderCodeChanged(Dictionary<string, string>? v)
    {
        if (product?.ProductInfo == null) return;
        product.ProductInfo.OrderCode = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private void OnArticleNumberChanged(Dictionary<string, string>? v)
    {
        if (product?.ProductInfo == null) return;
        product.ProductInfo.ArticleNumber = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    // ---------- File Upload ----------
    private async Task OnFilesChanged(IBrowserFile file)
    {
        selectedFile = file;
        if (selectedFile == null)
            return;

        await SaveImageFile(selectedFile);
        StateHasChanged();
    }

    private async Task SaveImageFile(IBrowserFile file)
    {
        var maxSize = 10 * 1024 * 1024; // 10 MB
        var fileName = file.Name;
        var uploadPath = Path.Combine("wwwroot/images", fileName);

        await using var fs = new FileStream(uploadPath, FileMode.Create);
        await file.OpenReadStream(maxSize).CopyToAsync(fs);

        if (product != null)
        {
            product.ImageUrl = $"/images/{fileName}";
            productImageUrl = product.ImageUrl;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (product == null)
            return;

        if (IsEditMode && selectedFile == null)
        {
            product.ImageUrl = productImageUrl;
        }

        product.CompanyId = CompanyInfo.CurrentCompany?.Id ?? CompanyId;
        await Mediator.Send(new CreateProductCommand(product));
        await ShowFirstProductDialog();
    }

    // ---------- Init ----------
    protected override async Task OnInitializedAsync()
    {
        var existingCompany = CompanyInfo.CurrentCompany?.CompanyManufacturerName;
        var existingAddress = CompanyInfo.CurrentCompany?.CompanyAddressInfo;

        var manufacturerDict = existingCompany is not null
                ? new Dictionary<string, string>(existingCompany, StringComparer.OrdinalIgnoreCase)
                : new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        var addressDto = new AddressInfoDto
        {
            ZipCode = (existingAddress?.ZipCode is not null)
                ? new Dictionary<string, string>(existingAddress.ZipCode, StringComparer.OrdinalIgnoreCase)
                : new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase),

            City = (existingAddress?.City is not null)
                ? new Dictionary<string, string>(existingAddress.City, StringComparer.OrdinalIgnoreCase)
                : new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase),

            Country = (existingAddress?.Country is not null)
                ? new Dictionary<string, string>(existingAddress.Country, StringComparer.OrdinalIgnoreCase)
                : new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        };

        product = new ProductDto
        {
            ManufacturerName = manufacturerDict,
            AddressInfo = addressDto,
            ProductInfo = new ProductInfoDto(),
            SerialNumber = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        };

        EnsureDictionariesInitialized(product);
    }

    private static void EnsureDictionariesInitialized(ProductDto p)
    {
        p.ManufacturerName ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.SerialNumber ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        p.AddressInfo ??= new AddressInfoDto();
        p.AddressInfo.ZipCode ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.AddressInfo.City ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.AddressInfo.Country ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        p.ProductInfo ??= new ProductInfoDto();
        p.ProductInfo.ProductFamily ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.ProductInfo.ProductRoot ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.ProductInfo.ProductType ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.ProductInfo.ProductDesignation ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.ProductInfo.OrderCode ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        p.ProductInfo.ArticleNumber ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private async Task ShowFirstProductDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialogRef = await DialogService.ShowAsync<FirstProductSuccessDialog>("", options: options);
        var result = await dialogRef.Result;
    }
}
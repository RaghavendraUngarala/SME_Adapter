@page "/manufacturerdetails"
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject SMEAdapter.Application.Services.CompanyInfoService CompanyInfo
@inject IDialogService DialogService

@using SMEAdapter.Application.DTOs
@using SMEAdapter.Application.Companies.Queries.GetCompanyById
@using SMEAdapter.Application.Companies.UpdateCompany
@using SMEAdapter.Application.Companies.CreateCompanies
@using SMEAdapter.Application.Companies.Queries.GetAllCompanies
@using SMEAdapter.Application.Companies.DeleteCompanies
@using SMEAdapter.Application.Products.Queries.GetProducts
@using SMEAdapter.Application.Products.UpdateProduct



<style>
    @@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

    .manufacturer-page {
        font-family: 'Poppins', 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .page-title {
        font-weight: 800;
        font-size: 2.75rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
    }

    .page-subtitle {
        font-weight: 500;
        font-size: 1.25rem;
        letter-spacing: -0.01em;
    }

    .stat-label {
        font-weight: 700;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .stat-number {
        font-weight: 800;
        font-size: 3.5rem;
        line-height: 1;
        letter-spacing: -0.03em;
    }

    .company-card {
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e0e0e0;
    }

        .company-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

    .add-company-card {
        border-radius: 12px;
        border: 2px dashed #ccc;
        transition: all 0.2s ease;
        cursor: pointer;
    }

        .add-company-card:hover {
            border-color: var(--mud-palette-primary);
            background-color: rgba(var(--mud-palette-primary-rgb), 0.05);
            transform: translateY(-4px);
        }

    .company-name {
        font-weight: 700;
        font-size: 1.3rem;
        letter-spacing: -0.02em;
    }

    .company-detail {
        font-weight: 500;
        font-size: 1rem;
    }

    .btn-text {
        font-weight: 600;
        font-size: 1rem;
        letter-spacing: 0.01em;
    }
</style>

<MudContainer MaxWidth="MaxWidth.False" Class="manufacturer-page py-6 px-6" Style="max-width: 100%;">

    <!-- Page Header -->
    <MudPaper Class="pa-6 mb-4" Elevation="3">
        <MudStack Spacing="2">
            <MudText Class="page-title">
                <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-3" Size="Size.Large" />
                Company Management
            </MudText>
            <MudText Class="page-subtitle" Color="Color.Secondary">
                Manage your company profiles and manufacturer details
            </MudText>
        </MudStack>
    </MudPaper>

    @if (isLoading)
    {
        <MudPaper Class="pa-12 text-center" Elevation="3">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Class="company-detail mt-4">Loading companies...</MudText>
        </MudPaper>
    }
    else
    {
        <!-- Stats Cards -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="company-card pa-6" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="2">
                            <MudText Class="stat-label" Color="Color.Secondary">TOTAL COMPANIES</MudText>
                            <MudText Class="stat-number" Color="Color.Primary">@companies.Count</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" Color="Color.Primary" Style="font-size: 3.5rem; opacity: 0.3;" />
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="company-card pa-6" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="2">
                            <MudText Class="stat-label" Color="Color.Secondary">ACTIVE COMPANY</MudText>
                            <MudText Style="font-weight: 700; font-size: 1.2rem;" Color="Color.Success">
                                @(CompanyInfo.CurrentCompany != null ? GetEnglish(CompanyInfo.CurrentCompany.CompanyManufacturerName) : "None")
                            </MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" Style="font-size: 3.5rem; opacity: 0.3;" />
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- Companies Grid -->
        <MudPaper Class="pa-6 mb-4" Elevation="3">
            <MudText Style="font-weight: 800; font-size: 2rem; margin-bottom: 1.5rem;">
                <MudIcon Icon="@Icons.Material.Filled.List" Class="mr-2" />
                Companies List
            </MudText>

            <MudDivider Class="mb-6" />

            @if (!companies.Any())
            {
                <MudPaper Class="pa-12 text-center" Elevation="0" Style="background: #f8f9fa; border-radius: 12px;">
                    <MudIcon Icon="@Icons.Material.Outlined.Business"
                             Color="Color.Secondary"
                             Style="font-size: 5rem; opacity: 0.3;" />
                    <MudText Style="font-weight: 800; font-size: 2rem;" Class="mt-4 mb-2">No Companies Yet</MudText>
                    <MudText Class="company-detail mb-6" Color="Color.Secondary">
                        Get started by adding your first company
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               Size="Size.Large"
                               OnClick="@AddCompany"
                               Class="btn-text">
                        Add Company
                    </MudButton>
                </MudPaper>
            }
            else
            {
                <MudGrid Spacing="3">
                    @foreach (var c in companies)
                    {
                        <MudItem xs="12" sm="6" md="4" lg="3">
                            <MudPaper Class="company-card pa-5" Elevation="2">
                                <MudStack Spacing="3">
                                    <!-- Company Icon & Name -->
                                    <MudStack Row="true" AlignItems="AlignItems.Start" Spacing="2">
                                        <MudAvatar Color="Color.Primary" Size="Size.Large" Style="width: 50px; height: 50px;">
                                            <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" />
                                        </MudAvatar>
                                        <MudStack Spacing="0" Style="flex: 1;">
                                            <MudText Class="company-name">
                                                @GetEnglish(c.CompanyManufacturerName)
                                            </MudText>
                                            @if (CompanyInfo.CurrentCompany?.Id == c.Id)
                                            {
                                                <MudChip T="String" Color="Color.Success"
                                                         Size="Size.Small"
                                                         Icon="@Icons.Material.Filled.CheckCircle"
                                                         Style="font-weight: 600;">
                                                    Active
                                                </MudChip>
                                            }
                                        </MudStack>
                                    </MudStack>

                                    <MudDivider />

                                    <!-- Company Details -->
                                    <MudStack Spacing="2">
                                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                                            <MudIcon Icon="@Icons.Material.Filled.LocationCity" Color="Color.Secondary" Size="Size.Small" />
                                            <MudText Class="company-detail" Color="Color.Secondary">
                                                @GetEnglish(c.CompanyAddressInfo.City)
                                            </MudText>
                                        </MudStack>

                                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Start">
                                            <MudIcon Icon="@Icons.Material.Filled.Public" Color="Color.Secondary" Size="Size.Small" />
                                            <MudText Class="company-detail" Color="Color.Secondary">
                                                @GetEnglish(c.CompanyAddressInfo.Country)
                                            </MudText>
                                        </MudStack>
                                    </MudStack>

                                    <MudDivider />

                                    <!-- Action Buttons -->
                                    <MudStack Row="true" Spacing="2">
                                        <MudButton Variant="Variant.Filled"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   FullWidth="true"
                                                   OnClick="@(() => EditCompany(c))"
                                                   Class="btn-text">
                                            Edit
                                        </MudButton>

                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Color="Color.Error"
                                                       Size="Size.Small"
                                                       OnClick="@(() => DeleteCompany(c))" />
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }

                    <!-- Add New Company Card -->
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <MudPaper Class="add-company-card pa-8"
                                  Elevation="0"
                                  @onclick="@AddCompany"
                                  Style="height: 100%; display: flex; align-items: center; justify-content: center;">
                            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                                <MudIcon Icon="@Icons.Material.Filled.AddBusiness"
                                         Size="Size.Large"
                                         Color="Color.Primary"
                                         Style="font-size: 4rem;" />

                                <MudText Style="font-weight: 700; font-size: 1.2rem;" Color="Color.Primary">
                                    Add New Company
                                </MudText>

                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Size="Size.Large"
                                           Class="btn-text"
                                           OnClick="AddCompany">
                                    Add Company
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private List<CompanyDto> companies = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCompanies();
        isLoading = false;
    }

    private async Task LoadCompanies()
    {
        companies = (await Mediator.Send(new GetAllCompaniesQuery())).ToList();
    }

    private string GetEnglish(Dictionary<string, string>? dict)
        => (dict != null && dict.TryGetValue("en", out var val))
            ? val
            : dict?.Values.FirstOrDefault() ?? "";

    private async Task AddCompany()
    {
        var options = new DialogOptions { CloseButton = false, FullWidth = false, MaxWidth = MaxWidth.Large };

        var dialog = DialogService.Show<CompanyFormDialog>("New Company", options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CompanyDto newCompany)
        {
            var newId = await Mediator.Send(new CreateCompanyCommand(newCompany));
            newCompany.Id = newId;

            
            Snackbar.Add("Company created successfully!", Severity.Success, config =>
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
            });

            await LoadCompanies();
            StateHasChanged();
        }
    }

    private async Task EditCompany(CompanyDto c)
    {
        var parameters = new DialogParameters
    {
        { "ExistingCompany", c }
    };

        var options = new DialogOptions { CloseButton = true, FullWidth = false, MaxWidth = MaxWidth.Large };
        var dialog = DialogService.Show<CompanyFormDialog>("Edit Company", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CompanyDto updated)
        {
            // First update the company
            await Mediator.Send(new UpdateCompanyCommand(updated));

            // Get all products
            var allProducts = await Mediator.Send(new GetAllProductsQuery());

            // Find products associated with THIS company (by CompanyId, not active status)
            var associatedProducts = allProducts.Where(p => p.CompanyId == c.Id).ToList();

            // Update each associated product
            if (associatedProducts.Any())
            {
                foreach (var product in associatedProducts)
                {
                    // Update manufacturer info
                    product.ManufacturerName = new Dictionary<string, string>(
                        updated.CompanyManufacturerName,
                        StringComparer.OrdinalIgnoreCase);

                    // Update address info
                    product.AddressInfo = new AddressInfoDto
                    {
                        ZipCode = new Dictionary<string, string>(
                            updated.CompanyAddressInfo.ZipCode,
                            StringComparer.OrdinalIgnoreCase),
                        City = new Dictionary<string, string>(
                            updated.CompanyAddressInfo.City,
                            StringComparer.OrdinalIgnoreCase),
                        Country = new Dictionary<string, string>(
                            updated.CompanyAddressInfo.Country,
                            StringComparer.OrdinalIgnoreCase)
                    };

                    // Keep the same CompanyId
                    product.CompanyId = updated.Id;

                    // Save the updated product
                    await Mediator.Send(new UpdateProductCommand(product));
                }

                Snackbar.Add($"Company '{GetEnglish(updated.CompanyManufacturerName)}' and {associatedProducts.Count} associated product(s) updated successfully!",
                    Severity.Success, config =>
                {
                   Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
                });
            }
            else
            {
                Snackbar.Add($"Company '{GetEnglish(updated.CompanyManufacturerName)}' updated successfully! (No associated products)",
                    Severity.Info, config =>
                {
                    Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
                });
            }

            // Update active company if this is the active one
            if (CompanyInfo.CurrentCompany?.Id == updated.Id)
            {
                CompanyInfo.SetCompany(updated);
            }

            await LoadCompanies();
            StateHasChanged();
        }
    }

    private async Task DeleteCompany(CompanyDto company)
    {
        var parameters = new DialogParameters
        {
            ["Title"] = "Delete Company",
            ["Message"] = "Are you sure you want to delete this company?",
            ["ItemToDelete"] = GetEnglish(company.CompanyManufacturerName),
            ["WarningMessage"] = "The following will be permanently deleted:",

        };

        var dialog = await DialogService.ShowAsync<ConfirmDeleteDialog>("", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await Mediator.Send(new DeleteCompanyCommand(company.Id));
            Snackbar.Add("Company deleted successfully", Severity.Success);
            if (CompanyInfo.CurrentCompany?.Id == company.Id)
            {
                CompanyInfo.CurrentCompany = null;
                
            }
            await LoadCompanies();
            StateHasChanged();
        }
        
    }

}
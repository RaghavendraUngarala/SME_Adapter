@page "/product"

@using MediatR;
@using SMEAdapter.Application.DTOs;
@inject SMEAdapter.Application.Services.ProductInfoService State
@inject NavigationManager navigate
@using SMEAdapter.Application.Products.CreateProduct
@inject IMediator Mediator
@inject ISnackbar  Snackbar
@inject IDialogService DialogService

@if (State.CurrentProductDetails != null)
{
<MudGrid>
    <MudItem xs="12" sm="12" md="12">
        <MudPaper Class="pa-6 ma-4" Elevation="8" Style="border: 1px solid lightgray; border-radius: 8px;">
                <EditForm Model="@State.CurrentProductDetails" OnValidSubmit="HandleValidSubmit" >
                    <DataAnnotationsValidator />

                 <MudExpansionPanels>

                     <MudExpansionPanel  Expanded="false" TextColor="Color.Primary" HeaderClass="mud-expand-panel-header">
                        <!-- Manufacturer Info -->
                            <TitleContent>
                                <MudText Typo="Typo.h4" Class="header-text">Manufacturer Info</MudText>
                            </TitleContent>
                            <ChildContent>
                                <MudText Typo="Typo.h5" Class="font-semibold">Manufacturer Name</MudText>
                                <MudTextField T="string" Variant="Variant.Outlined" HelperTextOnFocus="true" HelperText="Full legal name of the product manufacturer" 
                                                    @bind-Value="State.CurrentProductDetails.ManufacturerName"
                                                    For="@(() => State.CurrentProductDetails.ManufacturerName)"
                                                    Class="custom-font" Placeholder="MusterGmbh" />

                                <!-- Address Info -->

                                <MudText Typo="Typo.h5" Class="font-semibold">Address Info</MudText>
                                <MudDivider Class="my-2"></MudDivider>

                                <MudText Typo="Typo.h6" Class="font-semibold">ZipCode</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="ZIP or postal code for the manufacturer’s address" Variant="Variant.Outlined" 
                                                  @bind-Value="State.CurrentProductDetails.AddressInfo.ZipCode"
                                                  For="@(() => State.CurrentProductDetails.AddressInfo.ZipCode)"
                                              Class="custom-font" Placeholder="1234" />

                                <MudText Typo="Typo.h6" Class="font-semibold">City</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="City where the manufacturer is based" Variant="Variant.Outlined" 
                                                  @bind-Value="State.CurrentProductDetails.AddressInfo.City"
                                                  For="@(() => State.CurrentProductDetails.AddressInfo.City)"
                                              Class="custom-font" Placeholder="Musterstadt" />

                                <MudText Typo="Typo.h6" Class="font-semibold">Country</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Country where the manufacturer is based" Variant="Variant.Outlined" 
                                                  @bind-Value="State.CurrentProductDetails.AddressInfo.Country"
                                                  For="@(() => State.CurrentProductDetails.AddressInfo.Country)"
                                              Class="custom-font" Placeholder="Muster-Bundesland" />
                            </ChildContent>
                    </MudExpansionPanel>

                    <MudDivider Class="my-4" />

                     
                    <!-- Product Info -->
                     <MudExpansionPanel  Expanded="true" TextColor="Color.Primary" HeaderClass="mud-expand-panel-header">
                        <!-- Manufacturer Info -->
                            <TitleContent>
                                <MudText Typo="Typo.h4" Class="header-text">Product Info</MudText>
                            </TitleContent>
                     <ChildContent>

                                <MudText Typo="Typo.h6" Class="font-semibold">ProductFamily</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Group of related products that share similar features" Variant="Variant.Outlined" Placeholder="Type ABC"
                                    @bind-Value="State.CurrentProductDetails.ProductInfo.ProductFamily"
                                    For="@(() => State.CurrentProductDetails.ProductInfo.ProductFamily)"
                                    Class="custom-font" />


                                <MudText Typo="Typo.h6" Class="font-semibold">ProductRoot</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Base model from which product variants are derived" Variant="Variant.Outlined" Placeholder=""
                                    @bind-Value="State.CurrentProductDetails.ProductInfo.ProductRoot"
                                    For="@(() => State.CurrentProductDetails.ProductInfo.ProductRoot)"
                                    Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">ProductType</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="General category the product belongs to" Variant="Variant.Outlined" Placeholder="FM-ABC-1234"
                                    @bind-Value="State.CurrentProductDetails.ProductInfo.ProductType"
                                    For="@(() => State.CurrentProductDetails.ProductInfo.ProductType)"
                                    Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">ProductDesignation</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Official name used to market or identify this product" Variant="Variant.Outlined" Placeholder="ABC-123"
                                  @bind-Value="State.CurrentProductDetails.ProductInfo.ProductDesignation"
                                  For="@(() => State.CurrentProductDetails.ProductInfo.ProductDesignation)"
                                  Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">SerialNumber</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Internal code used for stock and inventory tracking" Variant="Variant.Outlined" Placeholder="12345678"
                                  @bind-Value="State.CurrentProductDetails.SerialNumber"
                                  For="@(() => State.CurrentProductDetails.SerialNumber)"
                                  Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">OrderCode</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Code customers use to order this exact configuration" Variant="Variant.Outlined" Placeholder="FMBABC12345"
                                    @bind-Value="State.CurrentProductDetails.ProductInfo.OrderCode"
                                    For="@(() => State.CurrentProductDetails.ProductInfo.OrderCode)"
                                    Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">ArticleNumber</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Unique identifier for each individual unit. Used for warranty and traceability" Variant="Variant.Outlined" Placeholder=""
                                  @bind-Value="State.CurrentProductDetails.ProductInfo.ArticleNumber"
                                  For="@(() => State.CurrentProductDetails.ProductInfo.ArticleNumber)"
                                  Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="mt-4">Upload Product Image</MudText>
                                <InputFile OnChange="OnFilesChanged" accept=".png,.jpg,.jpeg,.pdf" />
                    </ChildContent>
                </MudExpansionPanel>
                </MudExpansionPanels>
                    <MudDivider Class="my-4" />

                    <!-- Action Buttons -->
                    <MudStack Row="true" Spacing="2" Class="mt-4">
                        <MudButton @onclick=@SaveSnackBar Variant="Variant.Outlined" ButtonType="ButtonType.Submit" Color="Color.Primary"
                                   Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                            Save
                        </MudButton>

                        <MudButton Href="/viewproducts" Variant="Variant.Outlined" Color="Color.Secondary"
                                   Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                            Back
                        </MudButton>
                    </MudStack>
                </EditForm>
            </MudPaper>
</MudItem>
</MudGrid>
   
}
else
{
<MudGrid>
<MudItem xs="12" sm="12" md="6">
    <MudPaper Class="pa-6 ma-4" Elevation="8" Style="border: 1px solid lightgray; border-radius: 8px;">
               <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 50px;">
                <MudText Typo="Typo.h4" Align="Align.Center">No Company details found. Please enter company details</MudText>
                <MudButton Href="/companyform" Variant="Variant.Outlined" Color="Color.Secondary"
                           Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                    Add Company detials
                </MudButton>

                </div>
        </MudPaper>
    </MudItem>
</MudGrid>
}

<br/>

@code {

    [Parameter] public bool IsFirstProduct { get; set; }

    

    private async Task OnFilesChanged(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var path = Path.Combine("wwwroot/images", file.Name);

        using var fs = new FileStream(path, FileMode.Create);
        await file.OpenReadStream().CopyToAsync(fs);

        State.CurrentProductDetails.ImageUrl = $"images/{file.Name}";
    }

    private async Task HandleValidSubmit()
    {
        var command = new CreateProductCommand(State.CurrentProductDetails);
        await Mediator.Send(command);

        

        if (IsFirstProduct)
        {
            await ShowFirstProductDialog();
        }
        else
        {
            navigate.NavigateTo("/viewproducts");
        }
    }

    protected override void OnInitialized()
    {
        // Keep the company details as-is
        var existingCompany = State.CurrentProductDetails?.ManufacturerName;
        var existingAddress = State.CurrentProductDetails?.AddressInfo;

        // Reinitialize only product-specific fields
        State.CurrentProductDetails = new ProductDto
        {
            ManufacturerName = existingCompany,
            AddressInfo = existingAddress,
            ProductInfo = new ProductInfo(), // reset all product fields
            
        };
    }

    private void SaveSnackBar()
    {
        Snackbar.Add("The product has been added succesfully", Severity.Success, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });

    }

    private async Task ShowFirstProductDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialogRef = await DialogService.ShowAsync<FirstProductSuccessDialog>(
            "🎉 Congratulations",
            options: options
        );

        var result = await dialogRef.Result;

        

    }
}


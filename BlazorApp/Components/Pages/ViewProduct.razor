@page "/viewproducts"
@using MediatR
@using SMEAdapter.Application.DTOs
@inject IMediator Mediator
@using SMEAdapter.Application.Products.Queries.GetProducts
@using SMEAdapter.Application.Products.DeleteProduct
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar



@if (products == null)
{
    <p><em>Loading...</em></p>
}
else if (!products.Any())
{
 <MudGrid>
    <MudItem xs="12" sm="12" md="6">
    <MudPaper Class="pa-6 ma-4" Elevation="8" Style="border: 1px solid lightgray; border-radius: 8px;">
     <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 50px;">

        <MudText Typo= "Typo.h4">No product details found.Please add Company details first if not done</MudText>
        <MudButton  Variant="Variant.Outlined" Color="Color.Primary"  Size="Size.Large" onclick="NavigateToAddPage" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
            <MudIcon Icon="@Icons.Material.Filled.Add" /> Add Product
        </MudButton>
     </div>
    </MudPaper>
  </MudItem>
</MudGrid>
}
else
{
    <style type="text/css">
        .mud-table-head .header-centered th {
            text-align: center;
            font-size: 16px;
        }

        .mud-table-foot .bold-text .mud-table-cell {
            font-weight: 500;
        }
    </style>

    <MudTable @ref="_table" T="ProductDto" Items="@products" Breakpoint="Breakpoint.Sm" Striped="true" MultiSelection="true" SelectionChangeable="_selectionChangeable" Hover="true" Dense="true" Outlined="true" Elevation="2"
              Bordered="true" CustomHeader="true" @bind-SelectedItems="selectedItems" HeaderClass="table-head-bordered" SelectOnRowClick="true" Filter="new Func<ProductDto,bool>(FilterFunc1)">
        <ToolBarContent>
         
            <MudSpacer />
            <MudTextField @bind-Value="searchString1" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTHeadRow  Class="header-centered">
                <MudTh rowspan="2">Product Image</MudTh>
                 @if(ShowManufacturerInfo)
                {
                    <MudTh rowspan ="2">Manufacturer Name</MudTh>
                    <MudTh colspan="3">Address Info</MudTh>
                }
                <MudTh colspan="6">Product Info</MudTh>
                <MudTh rowspan ="2">Serial Number</MudTh>
               
            </MudTHeadRow>
            <MudTHeadRow Class="header-centered">
                @if(ShowManufacturerInfo)
                {
                <MudTh>Zip Code</MudTh>
                <MudTh>City</MudTh>
                <MudTh>Country</MudTh>
                }
                <MudTh>Designation</MudTh>
                <MudTh>Root</MudTh>
                <MudTh>Family</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Order Code</MudTh>
                <MudTh>Article Number</MudTh>
            </MudTHeadRow>
        </HeaderContent>
        <RowTemplate Context="product">
            
            <MudTd DataLabel = "Product Image">
                @if (!string.IsNullOrEmpty(product.ImageUrl))
                {
                    <img src="@product.ImageUrl"
                         alt="Product Image"
                         style="width:100px; height:100px; object-fit:contain; border-radius:4px;" />
                }
                else
                {
                    <MudText>No Image</MudText>
                }
            </MudTd>

            @if (ShowManufacturerInfo)
            {
            <MudTd DataLabel="Manufacturer Name" >@product.ManufacturerName</MudTd>

            <MudTd DataLabel="Zip Code">@product.AddressInfo.ZipCode</MudTd>
            <MudTd DataLabel="City">@product.AddressInfo.City</MudTd>
            <MudTd  DataLabel="Country">@product.AddressInfo.Country</MudTd>
            }
            <MudTd  DataLabel="Designation">@product.ProductInfo.ProductDesignation</MudTd>
            <MudTd  DataLabel="Root">@product.ProductInfo.ProductRoot</MudTd>
            <MudTd  DataLabel="Family">@product.ProductInfo.ProductFamily</MudTd>
            <MudTd  DataLabel="Type">@product.ProductInfo.ProductType</MudTd>
            <MudTd  DataLabel="Order Code">@product.ProductInfo.OrderCode</MudTd>
            <MudTd  DataLabel="Article Number">@product.ProductInfo.ArticleNumber</MudTd>
            <MudTd  DataLabel="Serial Number">@product.SerialNumber</MudTd>
        </RowTemplate>
       
    </MudTable>
    <MudSpacer/>

    <MudSwitch @bind-Value=@(ShowManufacturerInfo)
               Color="Color.Primary"
               Label="Show Manufacturer Info" />
    
    <div style="display: flex; gap: 20px;">
        <MudButton Class="mt-10" Variant="Variant.Outlined" Color="Color.Error" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';" Disabled="@(!CanDelete)" OnClick="DeleteSelectedProduct">
            <MudIcon Icon="@Icons.Material.Filled.Delete" /> Delete Product
        </MudButton>
        <MudButton Class="mt-10"  Variant="Variant.Outlined" Color="Color.Primary" Disabled="@(!CanEdit)" OnClick="NavigateToEditPage" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
            <MudIcon Icon="@Icons.Material.Filled.Edit" /> Edit Product
        </MudButton>
        <MudButton Class="mt-10" Variant="Variant.Outlined" Color="Color.Primary"  OnClick="NavigateToAddPage" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
            <MudIcon Icon="@Icons.Material.Filled.Add" /> Add Product
        </MudButton>
    </div>
}

@code {
    private List<ProductDto>? products;
    private MudTable<ProductDto> _table; 
    private HashSet<ProductDto> selectedItems = new(); 
    private bool _selectionChangeable = true; 
    private bool _selectOnRowClick = true; 
    private bool CanDelete => selectedItems?.Any() == true;
    private bool CanEdit => selectedItems?.Count == 1;

    private string searchString1 = "";
    private bool showDialog = false;
    private ProductDto? selectedProduct;
    private bool ShowManufacturerAndAddress = false;

    private bool ShowManufacturerInfo { get; set; } = false;

    

    private void NavigateToEditPage()
    {
        if (selectedItems.Count != 1)
        {
            Snackbar.Add("Please select exactly one product to edit.", Severity.Warning);
            return;
        }

        var selectedProductId = selectedItems.First().Id;
        Navigation.NavigateTo($"/editproduct/{selectedProductId}");
    }

    private void NavigateToAddPage()
    {
       
        Navigation.NavigateTo("/product");
    }

    private async Task DeleteSelectedProduct()
    {
        if (selectedItems == null || !selectedItems.Any())
            return;

        bool confirmed = await DialogService.ShowMessageBox(
            "Delete Products",
            $"Are you sure you want to delete {selectedItems.Count} selected products?",
            yesText: "Yes", noText: "No"
        ) == true;

        if (!confirmed)
            return;

        var idsToDelete = selectedItems.Select(p => Guid.Parse(p.Id.ToString())).ToList();
        await Mediator.Send(new DeleteProductCommand(idsToDelete));
        
        await LoadProducts(); 

        DeleteSnackBar(); // Show snackbar after deletion

        selectedItems.Clear();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        products = await Mediator.Send(new GetAllProductsQuery());
        StateHasChanged(); // Optional but helps force UI update
    }
    private void DeleteSnackBar()
    {
        Snackbar.Add("The selected products have been deleted", Severity.Info, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });

    }

    private bool FilterFunc1(ProductDto product) => FilterFunc(product, searchString1);

    private bool FilterFunc(ProductDto product, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (product.ManufacturerName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (product.SerialNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (product.ProductInfo.ProductDesignation.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (product.ProductInfo.ProductDesignation.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    }

}


@page "/viewproducts"
@using MediatR
@using SMEAdapter.Application.DTOs
@inject IMediator Mediator
@using SMEAdapter.Application.Products.Queries.GetProducts
@using SMEAdapter.Application.Products.DeleteProduct
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar



@if (products == null)
{
    <p><em>Loading...</em></p>
}
else if (!products.Any())
{
 <MudGrid>
    <MudItem xs="12" sm="12" md="6">
    <MudPaper Class="pa-6 ma-4" Elevation="8" Style="border: 1px solid lightgray; border-radius: 8px;">
     <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 50px;">

        <MudText Typo= "Typo.h4">No product details found.Please add Company details first if not done</MudText>
        <MudButton  Variant="Variant.Outlined" Color="Color.Primary"  Size="Size.Large" onclick="NavigateToAddPage" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
            <MudIcon Icon="@Icons.Material.Filled.Add" /> Add Product
        </MudButton>
     </div>
    </MudPaper>
  </MudItem>
</MudGrid>
}
else
{


    <style type="text/css">
        .mud-table-head .header-centered th {
            text-align: center;
            font-size: 16px;
        }

        .mud-table-foot .bold-text .mud-table-cell {
            font-weight: 500;
        }
    </style>

    <MudTable @ref="_table" T="ProductDto" Items="@products" Breakpoint="Breakpoint.Sm" Striped="true" MultiSelection="true" SelectionChangeable="_selectionChangeable" Hover="true" Dense="true" Outlined="true" Elevation="2"
              Bordered="true" CustomHeader="true" @bind-SelectedItems="selectedItems" HeaderClass="table-head-bordered" SelectOnRowClick="true" Filter="new Func<ProductDto,bool>(FilterFunc1)">
        <ToolBarContent>
         
            <MudSpacer />
            <MudTextField @bind-Value="searchString1" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTHeadRow  Class="header-centered">
                <MudTh rowspan="2">Product Image</MudTh>
                 @if(ShowManufacturerInfo)
                {
                    <MudTh rowspan ="2">Manufacturer Name</MudTh>
                    <MudTh colspan="3">Address Info</MudTh>
                }
                <MudTh colspan="6">Product Info</MudTh>
                <MudTh rowspan ="2" colspan ="1">Serial Number</MudTh>
                <MudTh colspan ="1" rowspan ="2"> Documents </MudTh>
               
            </MudTHeadRow>
            <MudTHeadRow Class="header-centered">
                @if(ShowManufacturerInfo)
                {
                    <MudTh>Zip Code</MudTh>
                    <MudTh>City</MudTh>
                    <MudTh>Country</MudTh>
                }
                <MudTh>Designation</MudTh>
                <MudTh>Root</MudTh>
                <MudTh>Family</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Order Code</MudTh>
                <MudTh>Article Number</MudTh>
            </MudTHeadRow>
        </HeaderContent>
        <RowTemplate Context="product">
            
            <MudTd DataLabel = "Product Image">
                @if (!string.IsNullOrEmpty(product.ImageUrl))
                {
                    <img src="@product.ImageUrl"
                         alt="Product Image"
                         style="width:100px; height:100px; object-fit:contain; border-radius:4px;" />
                }
                else
                {
                    <MudText>No Image</MudText>
                }
            </MudTd>

            @if (ShowManufacturerInfo)
            {
                <MudTd DataLabel="Manufacturer Name">@GetEnglishValue(product.ManufacturerName)</MudTd>
                <MudTd DataLabel="Zip Code">@GetEnglishValue(product.AddressInfo.ZipCode)</MudTd>
                <MudTd DataLabel="City">@GetEnglishValue(product.AddressInfo.City)</MudTd>
                <MudTd DataLabel="Country">@GetEnglishValue(product.AddressInfo.Country)</MudTd>
            }
            <MudTd DataLabel="Designation">@GetEnglishValue(product.ProductInfo.ProductDesignation)</MudTd>
            <MudTd DataLabel="Root">@GetEnglishValue(product.ProductInfo.ProductRoot)</MudTd>
            <MudTd DataLabel="Family">@GetEnglishValue(product.ProductInfo.ProductFamily)</MudTd>
            <MudTd DataLabel="Type">@GetEnglishValue(product.ProductInfo.ProductType)</MudTd>
            <MudTd DataLabel="Order Code">@GetEnglishValue(product.ProductInfo.OrderCode)</MudTd>
            <MudTd DataLabel="Article Number">@GetEnglishValue(product.ProductInfo.ArticleNumber)</MudTd>
            <MudTd DataLabel="Serial Number">@GetEnglishValue(product.SerialNumber)</MudTd>
            <MudTd DataLabel="Documents">
                 <MudStack Row="true" Spacing="1">

                    <MudChip T= "int" Color="Color.Success" Variant="Variant.Outlined" Size="Size.Small">
                            Owned: @product.OwnedDocumentCount
                    </MudChip>

                    <MudChip T = "int" Color="Color.Info" Variant="Variant.Outlined" Size="Size.Small">
                            Shared: @product.SharedDocumentCount
                    </MudChip>

                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   Class="ml-2"
                                   OnClick="@(() => ViewDocuments(product.Id))">
                            Manage
                        </MudButton>

                </MudStack>
            </MudTd>

           

        </RowTemplate>
       
    </MudTable>
    <MudSpacer/>

    <MudSwitch @bind-Value=@(ShowManufacturerInfo)
               Color="Color.Primary"
               Label="Show Manufacturer Info" />
    
    <div style="display: flex; gap: 20px;">
        <MudButton Class="mt-10" Variant="Variant.Filled" Color="Color.Error" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans'; width: 300px; height :60px" Disabled="@(!CanDelete)" OnClick="DeleteSelectedProduct">
            <MudIcon Icon="@Icons.Material.Filled.Delete" /> Delete Product
        </MudButton>
        <MudButton Class="mt-10" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!CanEdit)" OnClick="NavigateToEditPage" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans'; width: 300px; height :60px">
            <MudIcon Icon="@Icons.Material.Filled.Edit" /> Edit Product
        </MudButton>
        <MudButton Class="mt-10" Variant="Variant.Filled" Color="Color.Secondary"  OnClick="NavigateToAddPage" Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans'; width: 300px; height :60px">
            <MudIcon Icon="@Icons.Material.Filled.Add" /> Add Product
        </MudButton>
    </div>
}


@code {
    private List<ProductDto>? products;
    private MudTable<ProductDto>? _table; 
    private HashSet<ProductDto> selectedItems = new(); 
    private bool _selectionChangeable = true; 
    private bool _selectOnRowClick = true; 
    private bool CanDelete => selectedItems?.Any() == true;
    private bool CanEdit => selectedItems?.Count == 1;

    private string searchString1 = "";
    private bool showDialog = false;
    private ProductDto? selectedProduct;
    private bool ShowManufacturerAndAddress = false;

    private bool ShowManufacturerInfo { get; set; } = false;






    private string GetEnglishValue(Dictionary<string, string> dict)
    {
        if (dict == null) return string.Empty;

        // Try to get English value
        if (dict.TryGetValue("en", out var englishValue))
            return englishValue;

        // Fallback: return the first value if English not found
        return dict.Values.FirstOrDefault() ?? string.Empty;
    }

    private void NavigateToEditPage()
    {
        if (selectedItems.Count != 1)
        {
            Snackbar.Add("Please select exactly one product to edit.", Severity.Warning);
            return;
        }

        var selectedProductId = selectedItems.First().Id;
        Navigation.NavigateTo($"/editproduct/{selectedProductId}");
    }

    private void NavigateToAddPage()
    {

        Navigation.NavigateTo("/addproduct");
    }

    private async Task DeleteSelectedProduct()
    {
           if (selectedItems == null || !selectedItems.Any())
                    return;

            var parameters = new DialogParameters
            {
                { "Count", selectedItems.Count }
            };

            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Medium, 
            };

            var dialogRef = await DialogService.ShowAsync<DeleteProductsDialog>(
                "Delete Products",
                parameters,
                options
            );

            var result = await dialogRef.Result;

            if (result.Canceled)
                return;

            var idsToDelete = selectedItems.Select(p => p.Id).ToList();
            await Mediator.Send(new DeleteProductCommand(idsToDelete));

            await LoadProducts();
            DeleteSnackBar();

            selectedItems.Clear();
    }


    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        products = await Mediator.Send(new GetAllProductsQuery());
        StateHasChanged(); 
    }
    private void DeleteSnackBar()
    {
        Snackbar.Add("The selected products have been deleted", Severity.Info, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });

    }

    private bool FilterFunc1(ProductDto product) => FilterFunc(product, searchString1);

    private bool FilterFunc(ProductDto product, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        var searchLower = searchString.ToLower();

        // Check manufacturer name
        if (GetEnglishValue(product.ManufacturerName).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check serial number
        if (GetEnglishValue(product.SerialNumber).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check product designation
        if (GetEnglishValue(product.ProductInfo.ProductDesignation).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check product root
        if (GetEnglishValue(product.ProductInfo.ProductRoot).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check product family
        if (GetEnglishValue(product.ProductInfo.ProductFamily).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check product type
        if (GetEnglishValue(product.ProductInfo.ProductType).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check order code
        if (GetEnglishValue(product.ProductInfo.OrderCode).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check article number
        if (GetEnglishValue(product.ProductInfo.ArticleNumber).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
            return true;

        // Check address info if showing manufacturer info
        if (ShowManufacturerInfo)
        {
            if (GetEnglishValue(product.AddressInfo.ZipCode).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
                return true;

            if (GetEnglishValue(product.AddressInfo.City).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
                return true;

            if (GetEnglishValue(product.AddressInfo.Country).ToLower().Contains(searchLower, StringComparison.OrdinalIgnoreCase))
                return true;
        }

        return false;
    }
    private void ViewDocuments(Guid productId)
    {
        
        Navigation.NavigateTo($"/productdocument/{productId}");
    }

}


@page "/viewproducts"
@using MediatR
@using SMEAdapter.Application.DTOs
@inject IMediator Mediator
@using SMEAdapter.Application.Products.Queries.GetProducts
@using SMEAdapter.Application.Products.DeleteProduct
@inject IDialogService DialogService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap');

    .products-page {
        font-family: 'Poppins', 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .page-title {
        font-weight: 800;
        font-size: 2.75rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
    }

    .page-subtitle {
        font-weight: 500;
        font-size: 1.25rem;
        letter-spacing: -0.01em;
    }

    .stat-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

    .stat-label {
        font-weight: 700;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .stat-number {
        font-weight: 800;
        font-size: 3.5rem;
        line-height: 1;
        letter-spacing: -0.03em;
    }

    .table-header-text {
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
    }

    .body-text {
        font-weight: 500;
        font-size: 1.05rem;
    }

    .btn-text {
        font-weight: 600;
        font-size: 1.05rem;
        letter-spacing: 0.01em;
    }

    .section-title {
        font-weight: 800;
        font-size: 2rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
    }

    /* MudBlazor DataGrid Header Styling */
    ::deep .mud-table-head {
        font-weight: 700;
        font-size: 1.1rem;
    }

        ::deep .mud-table-head .mud-table-cell {
            font-weight: 700;
            font-size: 1.05rem;
            padding: 20px 16px;
        }

    ::deep .mud-table-cell {
        font-size: 1rem;
        padding: 16px;
    }
</style>

@if (products == null)
{
    <MudContainer MaxWidth="MaxWidth.False" Class="products-page py-6 px-6">
        <MudPaper Class="pa-12 text-center" Elevation="0">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Class="mt-4 body-text">Loading products...</MudText>
        </MudPaper>
    </MudContainer>
}
else if (!products.Any())
{
    <MudContainer MaxWidth="MaxWidth.False" Class="products-page py-6 px-6">
        <MudPaper Class="pa-12 text-center" Elevation="3">
            <MudIcon Icon="@Icons.Material.Outlined.Inventory"
                     Color="Color.Secondary"
                     Style="font-size: 5rem; opacity: 0.3;" />
            <MudText Class="section-title mt-4 mb-2">No Products Found</MudText>
            <MudText Class="body-text mb-6" Color="Color.Secondary">
                Please add company details first if not done, then add your first product
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="NavigateToAddPage"
                       Class="btn-text">
                Add Product
            </MudButton>
        </MudPaper>
    </MudContainer>
}
else
{
    <MudContainer MaxWidth="MaxWidth.False" Class="products-page py-6 px-6" Style="max-width: 100%;">

        <!-- Page Header -->
        <MudPaper Class="pa-6 mb-4" Elevation="3">
            <MudStack Spacing="2">
                <MudText Class="page-title">
                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-3" Size="Size.Large" />
                    Product Management
                </MudText>
                <MudText Class="page-subtitle" Color="Color.Secondary">
                    View, manage, and organize your product catalog
                </MudText>
            </MudStack>
        </MudPaper>

        <!-- Stats Cards -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="4">
                <MudPaper Class="stat-card pa-6" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <MudStack Spacing="2">
                            <MudText Class="stat-label" Color="Color.Secondary">TOTAL PRODUCTS</MudText>
                            <MudText Class="stat-number" Color="Color.Primary">@products.Count</MudText>
                        </MudStack>
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" Color="Color.Primary" Style="font-size: 3.5rem; opacity: 0.3;" />
                    </MudStack>
                </MudPaper>
            </MudItem>

           

            
        </MudGrid>

        <!-- Toolbar -->
        <MudPaper Class="pa-5 mb-4" Elevation="2">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Spacing="3">

                <!-- Search Box -->
                <MudTextField @bind-Value="searchString1"
                              Placeholder="Search products by any field..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium"
                              Class="flex-grow-1"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />

                <!-- Toggle and Add Button -->
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudSwitch @bind-Value="ShowManufacturerInfo"
                               Color="Color.Primary"
                               Label="Show Manufacturer Info"
                               Style="font-weight: 600;" />

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               Size="Size.Large"
                               OnClick="NavigateToAddPage"
                               Class="btn-text">
                        Add Product
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>

        <!-- Data Grid -->
        <MudPaper Class="pa-6" Elevation="3">

            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <MudText Class="section-title">
                    <MudIcon Icon="@Icons.Material.Filled.List" Class="mr-2" Size="Size.Large" />
                    Products List
                </MudText>

                @if (selectedItems?.Any() == true)
                {
                    <MudChip T="int" Color="Color.Info"
                             Icon="@Icons.Material.Filled.CheckCircle"
                             Size="Size.Large"
                             Style="font-weight: 600;">
                        @selectedItems.Count Selected
                    </MudChip>
                }
            </MudStack>

            <MudDivider Class="mb-6" />

            <MudDataGrid T="ProductDto"
                         Items="@products"
                         Filterable="true"
                         QuickFilter="@_quickFilter"
                         MultiSelection="true"
                         @bind-SelectedItems="selectedItems"
                         Hover="true"
                         Dense="false"
                         Striped="false"
                         Bordered="false"
                         Elevation="0">

                <Columns>
                    <SelectColumn T="ProductDto" />

                    <!-- Product Image -->
                    <TemplateColumn Title="Product Image">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Image</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            @if (!string.IsNullOrEmpty(context.Item.ImageUrl))
                            {
                                <MudAvatar Size="Size.Large" Style="width: 80px; height: 80px; border-radius: 8px;">
                                    <MudImage Src="@context.Item.ImageUrl"
                                              Alt="Product"
                                              ObjectFit="ObjectFit.Cover"
                                              Style="border-radius: 8px;" />
                                </MudAvatar>
                            }
                            else
                            {
                                <MudAvatar Color="Color.Secondary" Variant="Variant.Outlined" Size="Size.Large" Style="width: 80px; height: 80px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Image" />
                                </MudAvatar>
                            }
                        </CellTemplate>
                    </TemplateColumn>

                    @if (ShowManufacturerInfo)
                    {
                        <!-- Manufacturer Name -->
                        <TemplateColumn Title="Manufacturer Name">
                            <HeaderTemplate>
                                <MudText Class="table-header-text">Manufacturer</MudText>
                            </HeaderTemplate>
                            <CellTemplate Context="context">
                                <MudText Class="body-text">@GetEnglishValue(context.Item.ManufacturerName)</MudText>
                            </CellTemplate>
                        </TemplateColumn>

                        <!-- Zip Code -->
                        <TemplateColumn Title="Zip Code">
                            <HeaderTemplate>
                                <MudText Class="table-header-text">Zip Code</MudText>
                            </HeaderTemplate>
                            <CellTemplate Context="context">
                                <MudText Class="body-text">@GetEnglishValue(context.Item.AddressInfo.ZipCode)</MudText>
                            </CellTemplate>
                        </TemplateColumn>

                        <!-- City -->
                        <TemplateColumn Title="City">
                            <HeaderTemplate>
                                <MudText Class="table-header-text">City</MudText>
                            </HeaderTemplate>
                            <CellTemplate Context="context">
                                <MudText Class="body-text">@GetEnglishValue(context.Item.AddressInfo.City)</MudText>
                            </CellTemplate>
                        </TemplateColumn>

                        <!-- Country -->
                        <TemplateColumn Title="Country">
                            <HeaderTemplate>
                                <MudText Class="table-header-text">Country</MudText>
                            </HeaderTemplate>
                            <CellTemplate Context="context">
                                <MudText Class="body-text">@GetEnglishValue(context.Item.AddressInfo.Country)</MudText>
                            </CellTemplate>
                        </TemplateColumn>
                    }

                    <!-- Product Info -->
                    <TemplateColumn Title="Designation">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Designation</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudText Class="body-text" Style="font-weight: 600;">@GetEnglishValue(context.Item.ProductInfo.ProductDesignation)</MudText>
                        </CellTemplate>
                    </TemplateColumn>

                    <TemplateColumn Title="Root">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Root</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudText Class="body-text">@GetEnglishValue(context.Item.ProductInfo.ProductRoot)</MudText>
                        </CellTemplate>
                    </TemplateColumn>

                    <TemplateColumn Title="Family">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Family</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudText Class="body-text">@GetEnglishValue(context.Item.ProductInfo.ProductFamily)</MudText>
                        </CellTemplate>
                    </TemplateColumn>

                    <TemplateColumn Title="Type">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Type</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudText Class="body-text">@GetEnglishValue(context.Item.ProductInfo.ProductType)</MudText>
                        </CellTemplate>
                    </TemplateColumn>

                    <TemplateColumn Title="Order Code">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Order Code</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudText Class="body-text">@GetEnglishValue(context.Item.ProductInfo.OrderCode)</MudText>
                        </CellTemplate>
                    </TemplateColumn>

                    <TemplateColumn Title="Article Number">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Article No.</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudText Class="body-text">@GetEnglishValue(context.Item.ProductInfo.ArticleNumber)</MudText>
                        </CellTemplate>
                    </TemplateColumn>

                    <!-- Serial Number -->
                    <TemplateColumn Title="Serial Number">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Serial No.</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudText Class="body-text">@GetEnglishValue(context.Item.SerialNumber)</MudText>
                        </CellTemplate>
                    </TemplateColumn>

                    <!-- Documents -->
                    <TemplateColumn Title="Documents">
                        <HeaderTemplate>
                            <MudText Class="table-header-text">Documents</MudText>
                        </HeaderTemplate>
                        <CellTemplate Context="context">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudChip Color="Color.Success"
                                         Size="Size.Small"
                                         Style="font-weight: 600;">
                                    Owned: @context.Item.OwnedDocumentCount
                                </MudChip>

                                <MudChip Color="Color.Info"
                                         Size="Size.Small"
                                         Style="font-weight: 600;">
                                    Shared: @context.Item.SharedDocumentCount
                                </MudChip>

                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => ViewDocuments(context.Item.Id))"
                                           Style="font-weight: 600;">
                                    Manage
                                </MudButton>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>

            <!-- Bottom Actions -->
            <MudStack Row="true" Spacing="3" Class="mt-8">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Delete"
                           Size="Size.Large"
                           Disabled="@(!CanDelete)"
                           OnClick="DeleteSelectedProduct"
                           Class="btn-text">
                    Delete Selected (@selectedItems.Count)
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Edit"
                           Size="Size.Large"
                           Disabled="@(!CanEdit)"
                           OnClick="NavigateToEditPage"
                           Class="btn-text">
                    Edit Product
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudContainer>
}

@code {
    private List<ProductDto>? products;
    private HashSet<ProductDto> selectedItems = new();
    private bool CanDelete => selectedItems?.Any() == true;
    private bool CanEdit => selectedItems?.Count == 1;

    private string searchString1 = "";
    private bool ShowManufacturerInfo { get; set; } = false;

    private string GetEnglishValue(Dictionary<string, string> dict)
    {
        if (dict == null) return string.Empty;
        if (dict.TryGetValue("en", out var englishValue))
            return englishValue;
        return dict.Values.FirstOrDefault() ?? string.Empty;
    }

    private void NavigateToEditPage()
    {
        if (selectedItems.Count != 1)
        {
            Snackbar.Add("Please select exactly one product to edit.", Severity.Warning);
            return;
        }

        var selectedProductId = selectedItems.First().Id;
        Navigation.NavigateTo($"/editproduct/{selectedProductId}");
    }

    private void NavigateToAddPage()
    {
        Navigation.NavigateTo("/addproduct");
    }

    private async Task DeleteSelectedProduct()
    {
        if (selectedItems == null || !selectedItems.Any())
            return;
        var count = selectedItems.Count;
        var parameters = new DialogParameters
        {
            ["Title"] = "Delete Products",
            ["Count"] = count,
            ["ItemName"] = "product",
            ["ConfirmButtonText"] = count > 1 ? "Yes, Delete All" : "Yes, Delete",
            
        };

        var dialog = await DialogService.ShowAsync<ConfirmDeleteDialog>("", parameters);
        var result = await dialog.Result;

        if (result.Canceled)
            return;

        var idsToDelete = selectedItems.Select(p => p.Id).ToList();
        await Mediator.Send(new DeleteProductCommand(idsToDelete));

        await LoadProducts();
        Snackbar.Add($"{selectedItems.Count} products deleted successfully", Severity.Success);

        selectedItems.Clear();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        products = await Mediator.Send(new GetAllProductsQuery());
        StateHasChanged();
    }

    private Func<ProductDto, bool> _quickFilter => product =>
    {
        if (string.IsNullOrWhiteSpace(searchString1))
            return true;

        var q = searchString1.Trim().ToLower();

        if (ShowManufacturerInfo)
        {
            if (GetEnglishValue(product.ManufacturerName).ToLower().Contains(q)) return true;
            if (GetEnglishValue(product.AddressInfo.ZipCode).ToLower().Contains(q)) return true;
            if (GetEnglishValue(product.AddressInfo.City).ToLower().Contains(q)) return true;
            if (GetEnglishValue(product.AddressInfo.Country).ToLower().Contains(q)) return true;
        }

        if (GetEnglishValue(product.ProductInfo.ProductDesignation).ToLower().Contains(q)) return true;
        if (GetEnglishValue(product.ProductInfo.ProductRoot).ToLower().Contains(q)) return true;
        if (GetEnglishValue(product.ProductInfo.ProductFamily).ToLower().Contains(q)) return true;
        if (GetEnglishValue(product.ProductInfo.ProductType).ToLower().Contains(q)) return true;
        if (GetEnglishValue(product.ProductInfo.OrderCode).ToLower().Contains(q)) return true;
        if (GetEnglishValue(product.ProductInfo.ArticleNumber).ToLower().Contains(q)) return true;
        if (GetEnglishValue(product.SerialNumber).ToLower().Contains(q)) return true;
        if (product.OwnedDocumentCount.ToString().Contains(q)) return true;
        if (product.SharedDocumentCount.ToString().Contains(q)) return true;

        return false;
    };

    private void ViewDocuments(Guid productId)
    {
        Navigation.NavigateTo($"/productdocument/{productId}");
    }
}


@using MediatR;
@using SMEAdapter.Application.DTOs;
@inject SMEAdapter.Application.Services.CompanyInfoService  CompanyInfo
@inject NavigationManager navigate
@using SMEAdapter.Application.Products.CreateProduct
@inject IMediator Mediator
@inject ISnackbar  Snackbar
@inject IDialogService DialogService
@using BlazorApp.Components.Pages;
@using SMEAdapter.Application.Products.Queries.GetProducts
@using SMEAdapter.Application.Products.Queries.GetProductById
@using SMEAdapter.Application.Products.UpdateProduct

@if (product != null)
{
<MudGrid>
    <MudItem xs="12" sm="12" md="12">
        <MudPaper Class="pa-6 ma-4" Elevation="8" Style="border: 1px solid lightgray; border-radius: 8px;">
                <EditForm Model="@product" OnValidSubmit="HandleValidSubmit" >
                    <DataAnnotationsValidator />

                 <MudExpansionPanels>

                     <MudExpansionPanel  Expanded="false" TextColor="Color.Primary" HeaderClass="mud-expand-panel-header">
                        <!-- Manufacturer Info -->
                            <TitleContent>
                                <MudStack Row="true" AlignItems="AlignItems.Baseline">
                                    <MudText Typo="Typo.h4" Class="header-text">Manufacturer Info</MudText>
                                    <MudIconButton Icon="@Icons.Material.Filled.HelpOutline"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   Target="_blank"
                                                   Href="https://github.com/Ra-one77/SME_Adapter/wiki/Company-Details"
                                                   Style="margin-top: 10px;"
                                                   title="Help: Company Name" />
                                </MudStack>
                            </TitleContent>
                            <ChildContent>
                                <MudText Typo="Typo.h5" Class="font-semibold">Manufacturer Name</MudText>
                                <MudTextField T="string" Variant="Variant.Outlined" HelperTextOnFocus="true" HelperText="Full legal name of the product manufacturer" 
                                                    @bind-Value="product.ManufacturerName"
                                                    For="@(() => product.ManufacturerName)"
                                                    Class="custom-font" Placeholder="MusterGmbh" />

                                <!-- Address Info -->
                               
                                <MudText Typo="Typo.h5" Class="font-semibold">Address Info</MudText>
                             
                                
                                <MudDivider Class="my-2"></MudDivider>

                                <MudText Typo="Typo.h6" Class="font-semibold">ZipCode</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="ZIP or postal code for the manufacturer’s address" Variant="Variant.Outlined" 
                                                  @bind-Value="product.AddressInfo.ZipCode"
                                                  For="@(() => product.AddressInfo.ZipCode)"
                                              Class="custom-font" Placeholder="1234" />

                                <MudText Typo="Typo.h6" Class="font-semibold">City</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="City where the manufacturer is based" Variant="Variant.Outlined" 
                                                  @bind-Value="product.AddressInfo.City"
                                                  For="@(() => product.AddressInfo.City)"
                                              Class="custom-font" Placeholder="Musterstadt" />

                                <MudText Typo="Typo.h6" Class="font-semibold">Country</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Country where the manufacturer is based" Variant="Variant.Outlined" 
                                                  @bind-Value="product.AddressInfo.Country"
                                                  For="@(() => product.AddressInfo.Country)"
                                              Class="custom-font" Placeholder="Muster-Bundesland" />
                            </ChildContent>
                    </MudExpansionPanel>

                    <MudDivider Class="my-4" />

                     
                    <!-- Product Info -->
                     <MudExpansionPanel  Expanded="true" TextColor="Color.Primary" HeaderClass="mud-expand-panel-header">
                        <!-- Manufacturer Info -->
                            <TitleContent>
                                 <MudStack Row="true" AlignItems="AlignItems.Baseline">
                                    <MudText Typo="Typo.h4" Class="header-text">Product Info</MudText>
                                    <MudIconButton Icon="@Icons.Material.Filled.HelpOutline"
                                                   Color="Color.Primary"
                                                   Size="Size.Small"
                                                   Target="_blank"
                                                   Href="https://github.com/Ra-one77/SME_Adapter/wiki/Product-Info"
                                                   Style="margin-top: 10px;"
                                                   title="Help: Company Name" />
                                 </MudStack>
                            </TitleContent>
                     <ChildContent>

                                <MudText Typo="Typo.h6" Class="font-semibold">ProductFamily</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Group of related products that share similar features" Variant="Variant.Outlined" Placeholder="Type ABC"
                                    @bind-Value="product.ProductInfo.ProductFamily"
                                    For="@(() => product.ProductInfo.ProductFamily)"
                                    Class="custom-font" />


                                <MudText Typo="Typo.h6" Class="font-semibold">ProductRoot</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Base model from which product variants are derived" Variant="Variant.Outlined" Placeholder=""
                                    @bind-Value="product.ProductInfo.ProductRoot"
                                    For="@(() => product.ProductInfo.ProductRoot)"
                                    Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">ProductType</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="General category the product belongs to" Variant="Variant.Outlined" Placeholder="FM-ABC-1234"
                                    @bind-Value="product.ProductInfo.ProductType"
                                    For="@(() => product.ProductInfo.ProductType)"
                                    Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">ProductDesignation</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Official name used to market or identify this product" Variant="Variant.Outlined" Placeholder="ABC-123"
                                  @bind-Value="product.ProductInfo.ProductDesignation"
                                  For="@(() => product.ProductInfo.ProductDesignation)"
                                  Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">SerialNumber</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Internal code used for stock and inventory tracking" Variant="Variant.Outlined" Placeholder="12345678"
                                  @bind-Value="product.SerialNumber"
                                  For="@(() => product.SerialNumber)"
                                  Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">OrderCode</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Code customers use to order this exact configuration" Variant="Variant.Outlined" Placeholder="FMBABC12345"
                                    @bind-Value="product.ProductInfo.OrderCode"
                                    For="@(() => product.ProductInfo.OrderCode)"
                                    Class="custom-font" />

                                <MudText Typo="Typo.h6" Class="font-semibold">ArticleNumber</MudText>
                                <MudTextField T="string" HelperTextOnFocus="true" HelperText="Unique identifier for each individual unit. Used for warranty and traceability" Variant="Variant.Outlined" Placeholder=""
                                  @bind-Value="product.ProductInfo.ArticleNumber"
                                  For="@(() => product.ProductInfo.ArticleNumber)"
                                  Class="custom-font" />


                                <MudText Typo="Typo.h6" Class="mt-4">Product Image</MudText>

                                    <MudFileUpload T="IBrowserFile"
                                                   MaximumFileCount="1"
                                                   Accept="image/*"
                                                   FilesChanged="OnFilesChanged">
                                            <ActivatorContent>
                                                <MudButton Variant="Variant.Filled"
                                                           Color="Color.Secondary"
                                                           StartIcon="@Icons.Material.Filled.CloudUpload">
                                                    @(IsEditMode ? "Replace Image" : "Upload Image")
                                                </MudButton>
                                            </ActivatorContent>

                                    <SelectedTemplate Context="selectedFile">
                                                @if (selectedFile != null)
                                                {
                                                    <MudText>@selectedFile.Name</MudText>
                                                }
                                                else if (!string.IsNullOrWhiteSpace(product?.ImageUrl))
                                                {
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                        <MudAvatar Size="Size.Medium" Image="@product.ImageUrl" />
                                                        <MudText>@($"Current: {Path.GetFileName(product.ImageUrl)}")</MudText>
                                                    </MudStack>
                                                }
                                                else
                                                {
                                                    <MudText>No image selected</MudText>
                                                }
                                            </SelectedTemplate>
                                    </MudFileUpload>

                                    @if (!string.IsNullOrWhiteSpace(product?.ImageUrl))
                                    {
                                        <MudImage Src="@product.ImageUrl"
                                            Alt="Product Image"
                                            Width="150"
                                            Height="150"
                                            Style="border-radius: 8px; object-fit: cover; margin-top: 10px;" />
                                    }
                            </ChildContent>
                </MudExpansionPanel>
                </MudExpansionPanels>
                    <MudDivider Class="my-4" />

                    <!-- Action Buttons -->
                    <MudStack Row="true" Spacing="2" Class="mt-4">
                        <MudButton  Variant="Variant.Outlined" ButtonType="ButtonType.Submit" Color="Color.Primary"
                                   Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                            @(IsEditMode ? "Update" : "Save")
                        </MudButton>

                        <MudButton Href="/viewproducts" Variant="Variant.Outlined" Color="Color.Secondary"
                                   Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                            Back
                        </MudButton>
                    </MudStack>
                </EditForm>
            </MudPaper>
</MudItem>
</MudGrid>
   
}
else
{
<MudGrid>
<MudItem xs="12" sm="12" md="6">
    <MudPaper Class="pa-6 ma-4" Elevation="8" Style="border: 1px solid lightgray; border-radius: 8px;">
               <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 50px;">
                <MudText Typo="Typo.h4" Align="Align.Center">No Company details found. Please enter company details</MudText>
                <MudButton Href="/companyform" Variant="Variant.Outlined" Color="Color.Secondary"
                           Size="Size.Large" Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans';">
                    Add Company detials
                </MudButton>

                </div>
        </MudPaper>
    </MudItem>
</MudGrid>
}

<br/>

@code {

    [Parameter] public bool IsFirstProduct { get; set; }

    [Parameter] public bool IsEditMode { get; set; } = false;

    [Parameter] public Guid ProductId { get; set; }

    private ProductDto? product;

    private string productImageUrl;


    private IBrowserFile? _selectedFile;

    private async Task OnFilesChanged(IBrowserFile files)
    {
        _selectedFile = files;
        if (_selectedFile == null)
            return;

        await SaveImageFile(_selectedFile);
        StateHasChanged();
    }

    private async Task SaveImageFile(IBrowserFile file)
    {
        var maxSize = 10 * 1024 * 1024; // 10 MB
        var fileName = file.Name;
        var uploadPath = Path.Combine("wwwroot/images", fileName);

        await using var fs = new FileStream(uploadPath, FileMode.Create);
        await file.OpenReadStream(maxSize).CopyToAsync(fs);

        product.ImageUrl = $"/images/{fileName}";
        Console.WriteLine($"{product.ImageUrl}");
    }

    private async Task HandleValidSubmit()
    {
        if (IsEditMode && _selectedFile == null)
            product.ImageUrl = productImageUrl;
        Console.WriteLine($"Loaded product image URL: {productImageUrl}");
        if (IsEditMode)
        {
            await Mediator.Send(new UpdateProductCommand(product));
            EditSnackBar();
        }
        else
        {
            await Mediator.Send(new CreateProductCommand(product));
            SaveSnackBar();
        }

        if (IsFirstProduct)
            await ShowFirstProductDialog();
        else
            navigate.NavigateTo("/viewproducts");
    }

    protected override async Task OnInitializedAsync()
    {

        if (IsEditMode)
        {
            product = await Mediator.Send(new GetProductByIdQuery(ProductId));
            productImageUrl = product.ImageUrl ?? string.Empty;
        }
        else
        {
            // 🔹 Prepare new product template (like before)
            var existingCompany = CompanyInfo.CurrentCompany?.CompanyManufacturerName;
            var existingAddress = CompanyInfo.CurrentCompany?.CompanyAddressInfo;

            product = new ProductDto
            {
                ManufacturerName = existingCompany,
                AddressInfo = existingAddress != null
                    ? new AddressInfo
                    {
                        City = existingAddress.City,
                        ZipCode = existingAddress.ZipCode,
                        Country = existingAddress.Country
                    }
                    : new AddressInfo(),
                ProductInfo = new ProductInfo(),
            };
        }
    }

    private void SaveSnackBar()
    {
        Snackbar.Add("The product has been added succesfully", Severity.Success, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });

    }

    private async Task ShowFirstProductDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialogRef = await DialogService.ShowAsync<FirstProductSuccessDialog>(
            "🎉 Congratulations",
            options: options
        );

        var result = await dialogRef.Result; 

    }
    private void EditSnackBar()
    {
        Snackbar.Add("Changes have been saved succesfully", Severity.Success, config =>
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomLeft;
        });

    }
}


﻿@using SMEAdapter.Application.DTOs;
@using BlazorApp.Components.LangStringSetEditor;
@using SMEAdapter.Application.ProductDocuments.AddProductDocuments;
@using SMEAdapter.Application.ProductDocuments.Queries.GetProductDocumentsById;
@using SMEAdapter.Application.ProductDocuments.UpdateProductDocument;
@using MediatR;
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IDialogService DialogService
@using System.Globalization
@inject ISnackbar Snackbar

<MudGrid >
    <!-- Document Version -->
    @if (isLoading)
    {
        <MudItem xs="12">
            <MudPaper Class="pa-4" Outlined="true">
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                    <MudText Typo="Typo.subtitle1" Class="mt-2">Loading document details...</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    }
    else
    {
        <style>
            .file-upload-input {
                position: absolute;
                width: 100%;
                height: 100%;
                overflow: hidden;
                z-index: 10;
                opacity: 0;
            }
        </style>
        <MudItem xs="12" md="12">
        <MudPaper Elevation = "3"Class="pa-4 mb-4" Outlined="true">
            <MudText Typo="Typo.h4">File Upload</MudText>
            <MudFileUpload T="IBrowserFile" @ref="_fileUpload"
                           MaximumFileCount="1"
                           FilesChanged="FileUploaded"
                           InputClass="file-upload-input"
                           Hidden="false"
                           @ondrop="@ClearDragClass"
                           @ondragenter="@SetDragClass"
                           @ondragleave="@ClearDragClass"
                           @ondragend="@ClearDragClass">

                <ActivatorContent>
                    <MudPaper Height="180px"
                              Outlined="true"
                              Class="@_dragClass">
                        <MudText Typo="Typo.h6" Class="mb-2">
                            Drag & drop file here or click to upload
                        </MudText>

                        @if (_selectedFile != null)
                        {
                            <MudChip Color="Color.Primary" T="string" Text=@($"Selected File: {_selectedFile.Name}") Variant="Variant.Outlined" />

                        }
                        else if (!string.IsNullOrWhiteSpace(NewDocument.FileName))
                        {
                            <MudChip Color="Color.Info" T="string" Text=@($"Current File: {NewDocument.FileName}") Variant="Variant.Outlined" />


                        }
                        
                    </MudPaper>
                </ActivatorContent>

            </MudFileUpload>

                <MudStack Class="pa-8" Row="true">
                <MudButton Variant="Variant.Filled"
                           Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans'; width: 250px; height :60px"
                           Color="Color.Success"
                           Disabled="@(!fileUploaded && !IsEditMode)"
                           OnClick="SaveDocument">
                    @(IsEditMode ? "Update" : "Save")
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Style="font-size: 18px; font-weight: bold; font-family: 'Open Sans'; width: 250px; height :60px"
                           Color="Color.Secondary"
                           OnClick="ConfirmCancel">
                    Back
                </MudButton>
            </MudStack>

        </MudPaper>
        </MudItem>
        
        <MudItem xs="6" md="6">
            <MudPaper Class="pa-8" Elevation = "4" Outlined="true">
                <MudText Class="mb-4" Typo="Typo.h5">Document Version</MudText>
                <MudForm @ref="form">
                    <MudText Typo="Typo.h6">Language</MudText>
                    <MudSelect Class="mb-4" T="string"
                               
                               @bind-Value="NewDocument.Language"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Required="true"
                               Placeholder="Select Language">

                        @foreach (var opt in LanguageOptions)
                        {
                            <MudSelectItem T="string" Value="@opt.Code">
                                @opt.Display (@opt.Code)
                            </MudSelectItem>
                        }
                    </MudSelect>
                    <MudText Typo="Typo.h6">Version</MudText>
                    <MudTextField Class="mb-4" @bind-Value="NewDocument.Version" Variant="Variant.Outlined" />

                    <MudText Typo="Typo.h6">Title</MudText>
                    <div Class="mb-4">
                        <LangStringSetEditor Value="NewDocument.Title"
                                             ValueChanged="OnTitleChanged"
                                             Label="Title"
                                             InputLabel="Title"
                                             MinRows="1" />
                    </div>

                    <MudText Typo="Typo.h6">SubTitle</MudText>
                    <div Class="mb-4">
                        <LangStringSetEditor Value="NewDocument.SubTitle"
                                             ValueChanged="OnSubTitleChanged"
                                             Label="SubTitle"
                                             InputLabel="SubTitle"
                                             MinRows="1" />
                    </div>
                    <MudText Typo="Typo.h6">Description</MudText>
                    <div Class="mb-4">
                        <LangStringSetEditor Value="NewDocument.Description"
                                             ValueChanged="OnDescriptionChanged"
                                             Label="Description"
                                             InputLabel="Description"
                                             MinRows="1" />
                    </div>

                    <MudText Typo="Typo.h6">Keywords</MudText>
                    <div Class="mb-4">
                        <LangStringSetEditor Value="NewDocument.Keywords"
                                             ValueChanged="OnKeywordsChanged"
                                             Label="Keywords"
                                             InputLabel="Keywords"
                                             MinRows="1" />
                    </div>

                    <MudText Typo="Typo.h6">Status Value</MudText>
                    <MudTextField Class="mb-4" @bind-Value="NewDocument.StatusValue" Variant="Variant.Outlined" />

                    <MudText Typo="Typo.h6">Status Set Date</MudText>
                    <MudDatePicker Class="mb-4"
                                   @bind-Date="NewDocument.StatusSetDate"
                                   Label="Status Set Date"
                                   DateFormat="yyyy-MM-dd"
                                   Clearable="true" />

                    <MudText Typo="Typo.h6">Organisation Name</MudText>
                    <MudTextField Class="mb-4" @bind-Value="NewDocument.OrganisationName" Variant="Variant.Outlined" />

                    <MudText Typo="Typo.h6">Organisation Official Name</MudText>
                    <MudTextField Class="mb-4" @bind-Value="NewDocument.OrganisationOfficialName" Variant="Variant.Outlined" />
                </MudForm>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudPaper Elevation="4" Class="pa-4 mb-8" Outlined="true">
                <MudText Typo="Typo.h5" Class="mb-4">Document Ownership</MudText>
                <MudRadioGroup T="ProductDocument.DocumentOwnershipType"
                              @bind-Value="NewDocument.OwnershipType">
                    <MudRadio T="ProductDocument.DocumentOwnershipType"
                              Value="ProductDocument.DocumentOwnershipType.Owned"
                              Color="Color.Primary">
                        Owned (belongs ONLY to this product)
                    </MudRadio>

                    <MudRadio T="ProductDocument.DocumentOwnershipType"
                              Value="ProductDocument.DocumentOwnershipType.Shared"
                              Color="Color.Secondary">
                        Shared ( reusable across products )
                    </MudRadio>
                </MudRadioGroup>


            </MudPaper>
            <MudPaper Class="pa-4 mb-8" Elevation="6" Outlined="true">
                <MudText Class="mb-4" Typo="Typo.h5">Document Identifier</MudText>

                <MudText Typo="Typo.h6">Value ID</MudText>
                <MudTextField Class="mb-4" @bind-Value="NewDocument.ValueId" Variant="Variant.Outlined" />

                <MudText Typo="Typo.h6">Domain ID</MudText>
                <MudTextField Class="mb-4" @bind-Value="NewDocument.DomainId" Variant="Variant.Outlined" />
            </MudPaper>

            <MudPaper Class="pa-4 mb-4" Outlined="true">
                <MudText Typo="Typo.h5" Class="mb-4">Document Classification</MudText>

                <MudText Typo="Typo.h6">Classification System</MudText>
                <MudTextField Class="mb-4" @bind-Value="NewDocument.ClassificationSystem" Variant="Variant.Outlined" />


                <MudText Typo="Typo.h6">ClassName</MudText>

                <div Class="mb-4">
                    <LangStringSetEditor Value="NewDocument.ClassName"
                                         ValueChanged="OnClassNameChanged"
                                         Label="ClassName"
                                         InputLabel="CLassName"
                                         MinRows="1" />
                </div>

                <MudText Typo="Typo.h6">ClassLang</MudText>
                <MudTextField Class="mb-4" @bind-Value="NewDocument.ClassLang" Variant="Variant.Outlined" />

                <MudText Typo="Typo.h6">ClassDescription</MudText>
                <MudTextField Class="mb-4" @bind-Value="NewDocument.ClassDescription" Variant="Variant.Outlined" />

                <MudText Typo="Typo.h6">ClassId</MudText>
                <MudTextField Class="mb-4" @bind-Value="NewDocument.ClassId" Variant="Variant.Outlined" />
            </MudPaper>

        </MudItem>
        
      


       

    }
</MudGrid>

@code {

    [Parameter]
    public Guid ProductId { get; set; }

    [Parameter]
    public bool IsEditMode { get; set; }

    [Parameter]
    public Guid? DocumentId { get; set; }

    [Parameter]
    public bool FormValue { get; set; }

    [Parameter]
    public EventCallback<bool> FormValueChanged { get; set; }

    [Parameter]
    public EventCallback<ProductDocumentDto> OnSaved { get; set; }

    private record LangOpt(string Code, string Display);

    private bool fileUploaded = false;
    private bool isLoading = false;

    IList<IBrowserFile> _files = new List<IBrowserFile>();

    private MudForm? form;

    private ProductDocumentDto NewDocument = new();

    private IBrowserFile? _selectedFile;

    private MudFileUpload<IBrowserFile>? _fileUpload;
    private List<LangOpt> LanguageOptions = CultureInfo
    .GetCultures(CultureTypes.NeutralCultures)
    .Where(c => c.TwoLetterISOLanguageName.Length == 2)
    .GroupBy(c => c.TwoLetterISOLanguageName)  // remove duplicates
    .Select(g =>
    {
        var code = g.Key;
        var culture = g.First();
        return new LangOpt(
            code,
            CultureInfo.GetCultureInfo(code).EnglishName // display in English
        );
    })
    .OrderBy(x => x.Display)
    .ToList();


    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode && DocumentId.HasValue)
        {
            // Fetch existing document from backend
            NewDocument = await Mediator.Send(new GetProductDocumentByIdQuery(DocumentId.Value));
            
            EnsureDictionariesInitialized(NewDocument);
            fileUploaded = true; 

            StateHasChanged();
        }
        else
        {
            // Creating a new one
            NewDocument = new ProductDocumentDto();
            EnsureDictionariesInitialized(NewDocument);
        }
    }

    private const string DefaultDragClass =
        "relative rounded-lg border-2 border-dashed pa-4 mud-width-full mud-height-full";

    private string _dragClass = DefaultDragClass;

   

    private async Task OpenFilePickerAsync()
        => await (_fileUpload?.OpenFilePickerAsync() ?? Task.CompletedTask);

    private async Task ClearAsync()
    {
        _selectedFile = null;
        await _fileUpload?.ClearAsync()!;
        ClearDragClass();
    }

    private void Upload()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
        Snackbar.Add("TODO: Upload your file!");
    }

    private void SetDragClass()
        => _dragClass = $"{DefaultDragClass} mud-border-primary";

    private void ClearDragClass()
        => _dragClass = DefaultDragClass;
    


    private static void EnsureDictionariesInitialized(ProductDocumentDto d)
    {
        d.ClassName ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        d.Title ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        d.SubTitle ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        d.Description ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        d.Keywords ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }
    private void OnClassNameChanged(Dictionary<string, string>? v)
    {
        if (NewDocument == null) return;
        NewDocument.ClassName = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }
    private void OnTitleChanged(Dictionary<string, string>? v)
    {
        if (NewDocument == null) return;
        NewDocument.Title = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }
    private void OnSubTitleChanged(Dictionary<string, string>? v)
    {
        if (NewDocument == null) return;
        NewDocument.SubTitle = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }
    private void OnDescriptionChanged(Dictionary<string, string>? v)
    {
        if (NewDocument == null) return;
        NewDocument.Description = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }
    private void OnKeywordsChanged(Dictionary<string, string>? v)
    {
        if (NewDocument == null) return;
        NewDocument.Keywords = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private async Task FileUploaded(IBrowserFile files)
    {
        _selectedFile = files;
        fileUploaded = _selectedFile is not null;
    }
    
    private async Task SaveDocument()
    {
        // Always ensure ProductId is set, regardless of file upload
        NewDocument.ProductId = ProductId;   // 🔥 CRITICAL FIX

        // Handle file upload if there is a new file
        if (_selectedFile is not null)
        {
            using var ms = new MemoryStream();
            await _selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024)
                               .CopyToAsync(ms);

            var fileBytes = ms.ToArray();

            NewDocument.FileName = _selectedFile.Name;
            NewDocument.ContentType = _selectedFile.ContentType;
            NewDocument.StatusSetDate ??= DateTime.UtcNow;
            NewDocument.Data = fileBytes;
        }

        // CREATE MODE
        if (!DocumentId.HasValue)
        {
            await Mediator.Send(new CreateProductDocumentCommand(NewDocument));
        }
        else
        {
            // UPDATE MODE (ProductId must already be set above)
            await Mediator.Send(new UpdateProductDocumentCommand(NewDocument));
        }

        // Notify parent page
        await OnSaved.InvokeAsync(NewDocument);

        // Reset form in create mode
        if (!DocumentId.HasValue)
        {
            NewDocument = new();
            _selectedFile = null;
            fileUploaded = false;
        }
    }

    private async Task ConfirmCancel()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Discard Changes?",
            "You have unsaved changes. Are you sure you want to cancel?",
            yesText: "Yes, discard",
            cancelText: "No");
        if (result != true)
            return;
        Console.WriteLine($"Dialog closed. Result = {result}");

        if (IsEditMode)
        {
            // Edit Mode → navigate back to parent page
            Navigation.NavigateTo($"/productdocument/{ProductId}");
        }
        else
        {
            // Add Mode → just tell parent to hide this form
            await Task.Delay(100);
            await FormValueChanged.InvokeAsync(false);

        }




    }
}
﻿@using SMEAdapter.Application.DTOs;
@using BlazorApp.Components.LangStringSetEditor;
@using SMEAdapter.Application.ProductDocuments.AddProductDocuments;
@using SMEAdapter.Application.ProductDocuments.Queries.GetProductDocumentsById;
@using SMEAdapter.Application.ProductDocuments.UpdateProductDocument;
@using MediatR;
@inject IMediator Mediator
@inject NavigationManager Navigation
@inject IDialogService DialogService
@using System.Globalization


<MudGrid Spacing="3">
    <!-- Document Version -->
    @if (isLoading)
    {
        <MudItem xs="12">
            <MudPaper Class="pa-4" Outlined="true">
                <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                    <MudText Typo="Typo.subtitle1" Class="mt-2">Loading document details...</MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    }
    else
    {
        <!-- Document Version -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Outlined="true">
                <MudText Typo="Typo.h6">Document Version</MudText>
                <MudForm @ref="form">
                    <MudSelect T="string"
                               Label="Language"
                               @bind-Value="NewDocument.Language"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Required="true"
                               Placeholder="Select Language">

                        @foreach (var opt in LanguageOptions)
                        {
                            <MudSelectItem T="string" Value="@opt.Code">
                                @opt.Display (@opt.Code)
                            </MudSelectItem>
                        }
                    </MudSelect>
                    <MudTextField @bind-Value="NewDocument.Version" Label="Version" />
                    <MudTextField @bind-Value="NewDocument.Title" Label="Title" />
                    <MudTextField @bind-Value="NewDocument.Summary" Label="Summary" Lines="3" />
                    <MudTextField @bind-Value="NewDocument.Keywords" Label="Keywords" />
                    <MudTextField @bind-Value="NewDocument.State" Label="State" />
                    <MudDatePicker @bind-Date="NewDocument.StateDate" Label="State Date" />
                    <MudTextField @bind-Value="NewDocument.OrganisationName" Label="Organisation Name" />
                    <MudTextField @bind-Value="NewDocument.OrganisationOfficialName" Label="Organisation Official Name" />
                </MudForm>
            </MudPaper>
        </MudItem>

        <!-- Document Identifier -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Outlined="true">
                <MudText Typo="Typo.h6">Document Identifier</MudText>
                <MudTextField @bind-Value="NewDocument.ValueId" Label="Value ID" />
                <MudTextField @bind-Value="NewDocument.DomainId" Label="Domain ID" />
            </MudPaper>
        </MudItem>

        <!-- Document Classification -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Outlined="true">
                <MudText Typo="Typo.h6">Document Classification</MudText>
                <MudTextField @bind-Value="NewDocument.ClassificationSystem" Label="Classification System" />
                <LangStringSetEditor Value="NewDocument.ClassName"
                                                 ValueChanged="OnClassNameChanged"
                                                 Label="ClassName"
                                                 InputLabel="CLassName"
                                                 MinRows="1"
                                                  />
                <MudTextField @bind-Value="NewDocument.ClassLang" Label="Class Language" />
                <MudTextField @bind-Value="NewDocument.ClassDescription" Label="Class Description" />
                <MudTextField @bind-Value="NewDocument.ClassId" Label="Class ID" />
            </MudPaper>
        </MudItem>

        <!-- File Upload -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Outlined="true">
                <MudText Typo="Typo.h6">File Upload</MudText>
                <MudFileUpload T="IBrowserFile" MaximumFileCount="1" FilesChanged="FileUploaded">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   StartIcon="@Icons.Material.Filled.CloudUpload">
                            @(IsEditMode ? "Replace File" : "Upload File")
                        </MudButton>
                    </ActivatorContent>
                    <SelectedTemplate>
                        @if (_selectedFile != null)
                        {
                            <MudText>@_selectedFile.Name</MudText>
                        }
                        else if (!string.IsNullOrWhiteSpace(NewDocument.FileName))
                        {
                            <MudText>@($"Current File: {NewDocument.FileName}")</MudText>
                        }
                        else
                        {
                            <MudText>No File Selected</MudText>
                        }
                    </SelectedTemplate>
                </MudFileUpload>

            </MudPaper>
        </MudItem>

        <!-- Save Button -->
        <MudItem xs="12">
            <MudPaper Class="pa-4" Outlined="true">
                <MudStack Row="true">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               Disabled="@(!fileUploaded && !IsEditMode)"
                               OnClick="SaveDocument">
                        @(IsEditMode ? "Update" : "Save")
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               OnClick="ConfirmCancel">
                        Cancel
                    </MudButton>
                </MudStack>

            </MudPaper>
        </MudItem>

    }
</MudGrid>

@code {

    [Parameter]
    public Guid ProductId { get; set; }

    [Parameter]
    public bool IsEditMode { get; set; }

    [Parameter]
    public Guid? DocumentId { get; set; }

    [Parameter]
    public bool FormValue { get; set; }

    [Parameter]
    public EventCallback<bool> FormValueChanged { get; set; }

    [Parameter]
    public EventCallback<ProductDocumentDto> OnSaved { get; set; }

    private record LangOpt(string Code, string Display);

    private bool fileUploaded = false;
    private bool isLoading = false;

    IList<IBrowserFile> _files = new List<IBrowserFile>();

    private MudForm? form;

    private ProductDocumentDto NewDocument = new();

    private IBrowserFile? _selectedFile;

    private List<LangOpt> LanguageOptions = CultureInfo
    .GetCultures(CultureTypes.NeutralCultures)
    .Where(c => c.TwoLetterISOLanguageName.Length == 2)
    .GroupBy(c => c.TwoLetterISOLanguageName)  // remove duplicates
    .Select(g =>
    {
        var code = g.Key;
        var culture = g.First();
        return new LangOpt(
            code,
            CultureInfo.GetCultureInfo(code).EnglishName // display in English
        );
    })
    .OrderBy(x => x.Display)
    .ToList();


    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode && DocumentId.HasValue)
        {
            // Fetch existing document from backend
            NewDocument = await Mediator.Send(new GetProductDocumentByIdQuery(DocumentId.Value));
            EnsureDictionariesInitialized(NewDocument);
            fileUploaded = true; 

            StateHasChanged();
        }
        else
        {
            // Creating a new one
            NewDocument = new ProductDocumentDto();
            EnsureDictionariesInitialized(NewDocument);
        }
    }


    


    private static void EnsureDictionariesInitialized(ProductDocumentDto d)
    {
        d.ClassName ??= new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }
    private void OnClassNameChanged(Dictionary<string, string>? v)
    {
        if (NewDocument == null) return;
        NewDocument.ClassName = v ?? new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
    }

    private async Task FileUploaded(IBrowserFile files)
    {
        _selectedFile = files;
        fileUploaded = _selectedFile is not null;
    }
    
    private async Task SaveDocument()
    {
        if (_selectedFile is null)
            return;

        using var ms = new MemoryStream();
        await _selectedFile.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024).CopyToAsync(ms);
        var fileBytes = ms.ToArray();

        NewDocument.ProductId = ProductId;
        NewDocument.StateDate = DateTime.UtcNow;
        NewDocument.FileName = _selectedFile.Name;
        NewDocument.ContentType = _selectedFile.ContentType;
        NewDocument.Data = fileBytes;

        if (!DocumentId.HasValue)
        {
            // CREATE MODE
            NewDocument.ProductId = ProductId;
            NewDocument.StateDate = DateTime.UtcNow;

            await Mediator.Send(new CreateProductDocumentCommand(NewDocument));
        }
        else
        {
            // UPDATE MODE
            await Mediator.Send(new UpdateProductDocumentCommand(NewDocument));
        }


        await OnSaved.InvokeAsync(NewDocument);

        // Reset state
        if (!DocumentId.HasValue)
        {
            NewDocument = new();
            _selectedFile = null;
            fileUploaded = false;
        }
    }

    private async Task ConfirmCancel()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Discard Changes?",
            "You have unsaved changes. Are you sure you want to cancel?",
            yesText: "Yes, discard",
            cancelText: "No");
        if (result != true)
            return;
        Console.WriteLine($"Dialog closed. Result = {result}");

        if (IsEditMode)
        {
            // Edit Mode → navigate back to parent page
            Navigation.NavigateTo($"/productdocument/{ProductId}");
        }
        else
        {
            // Add Mode → just tell parent to hide this form
            await Task.Delay(100);
            await FormValueChanged.InvokeAsync(false);

        }




    }
}